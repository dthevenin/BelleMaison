/*
*                    COPYRIGHT NOTICE
*
* Copyright (C) 2009-2011. ViniSketch SARL (c) All rights reserved
*
* THIS SOURCE CODE, ALL THE INTELLECTUAL PROPERTY RIGHTS THAT IT
* CONTAINS, AND ALL COPYRIGHTS PERTAINING THERETO ARE THE EXCLUSIVE
* PROPERTY OF VINISKETCH.
*
* THIS SOURCE CODE SHALL NOT BE DISTRIBUTED, COPIED OR REPRODUCED IN
* FULL OR IN PART, NOR SHALL DERIVATIVE WORKS BE CREATED BASED ON THIS
* SOURCE CODE OR THE RELATED SPECIFICATION.
*
* THIS SOURCE CODE MAY BE USED OR COMPILED SOLELY FOR THE PURPOSE OF
* PORTING THE PRODUCT ONTO VENDOR'S SOLUTION. THIS SOURCE
* CODE MAY NOT BE MODIFIED, EVEN PARTIALLY.
*
* THE PRESENT COPYRIGHT NOTICE MAY NOT BE CHANGED NOR REMOVED FROM THE
* PRESENT FILE.
*/

/**
 * @private
 */
function __setPos (node, x, y)
{
  if (!node) { return; }
  node.normalStyle.left = x + 'px';
  node.normalStyle.top = y + 'px';
}

/**
 * @private
 */
function __setSize (node, w, h)
{
  if (!node) { return; }
  node.normalStyle.width = w + 'px';
  node.normalStyle.height = h + 'px';
}

/**
 * @private
 */
function __setVisible (node, v)
{
  if (!node) { return; }
  if (node.normalStyle)
  {
    if (v)
    {
      node.normalStyle.visibility = "visible";
    }
    else
    {
      node.normalStyle.visibility = "hidden";
    }
  }
}

/**
 * @private
 */
function __getSize (node)
{
  var r = new Array ();
  r[0] = 0; r[1] = 0
  if (!node) { return r; }

  r [0] = parseInt (node.normalStyle.width, 10);
  r [1] = parseInt (node.normalStyle.height, 10);
  
  if (isNaN (r[0])) r[0] = 0;
  if (isNaN (r[1])) r[1] = 0;
  return r;
}


/**
 * @private
 */
function __getTagName (node)
{
  if (!node.tagName) { return undefined; }
  
  if (typeof node.tagName == "string") { return node.tagName; }
  if (typeof node.tagName == "function") { return node.tagName (); }
  return undefined;
}

/**
 * @private
 */
function __getBorderWidth (node)
{
  if (!node) return 0;
  var v = parseInt (node.normalStyle.borderWidth, 10);
  if (isNaN (v)) return 0;
  return v;
}

/**
 * @private
 */
function __getPaddingTop (node)
{
  if (!node) return 0;
  var v = parseInt (node.normalStyle.paddingTop, 10);
  if (isNaN (v)) return 0;
  return v;
}

/**
 * @private
 */
function __getPaddingBottom (node)
{
  if (!node) return 0;
  var v = parseInt (node.normalStyle.paddingBottom, 10);
  if (isNaN (v)) return 0;
  return v;
}

/**
 * @private
 */
function __getPaddingRight (node)
{
  if (!node) return 0;
  var v = parseInt (node.normalStyle.paddingRight, 10);
  if (isNaN (v)) return 0;
  return v;
}

/**
 * @private
 */
function __getPaddingLeft (node)
{
  if (!node) return 0;
  var v = parseInt (node.normalStyle.paddingLeft, 10);
  if (isNaN (v)) return 0;
  return v;
}

/**
 * @private
 */
function __isVisible (node)
{
  if (!node) { return false; }
  
  if (node.normalStyle || typeof (node.innerHTML) == 'string')
  {
    if (node.normalStyle.visibility == 'hidden') { return false; }
    else { return true; }
  }
/*  else if (node instanceof CharacterData) */
  {
    return true;
  }
}

/**
 * @private
 */
function __setInnerText (node, text)
{
  if (!node || !node.firstChild) { return; }
  
  node.firstChild.data = text;
};

/**
 * @private
 */
function __getInnerText (node)
{
  if (!node || !node.firstChild) { return "";}
  if (!node.firstChild) { return ""; }
  return node.firstChild.data;
};

/**
 * @private
 */
var abview_proto = new Object ();

/**
 *  The ABView class
 *
 *  @extends ABEventSource
 *  @class
 *  ABView is a class that defines the basic drawing, event-handling, of 
 *  an application. You typically don’t interact with the ABView API
 *  directly; rather, your custom view classes inherit from ABView and
 *  override many of its methods.
 *  <p>
 *  If you’re not creating a custom view class, there are few methods you
 *  need to use
 *
 *  <p>
 *  Navigation delegate methods:
 *  <ul>
 *    <li/>onFocus : function (obj), Called when the view has the focus
 *    <li/>onBlur : function (obj), Called when the view loses the focus
 *    <li/>onBeforeActive : function (obj), Called juste before the view
 *       will be active
 *    <li/>onActive : function (obj), Called when the view is active
 *    <li/>onLeft : function (obj), Called when the view receive a left
 *      key event
 *    <li/>onRight : function (obj), Called when the view receive a right
 *      key event
 *    <li/>onUp : function (obj), Called when the view receive a up
 *      key event
 *    <li/>onDown : function (obj), Called when the view receive a down
 *      key event
 *  </ul>
 *  <p>
 *  @example
 *
 *  @author David Thevenin
 *
 *  @constructor
 *   Creates a new ABView
 *  @name ABView
 *
 *	@param {Object} config the configuration stucture [mandatory]
*/
function abview_constructor (config)
{
  this._pos = new Array (2);
  this._pos [0] = -1;
  this._pos [1] = -1;
  this._size = new Array (2);
  this._size [0] = -1;
  this._size [1] = -1;
  
  if (!config) { config = new Object (); }

  var _id;
  if (config.id) { _id = config.id; }
  else
  {
    _id = ABObject.createId ();
    config.id = _id;
  }

  this.apply ('ABEventSource', '_constructor', _id);
  
  this._holes = new Object ();
  this.children = new Object ();

  this.view = this._getGUInode (config);
  if (!this.view)
  {
    printlnConsole ('ABView constructor failed. No view!');
    return;
  }
  this.view.id = this.id;
  this.view._comp_ = this;
  
  this._instrument_view (this.view);
  this._parse_view (this.view);
}
abview_proto._constructor = abview_constructor;
/********************************************************************
                    Layout constant
*********************************************************************/

/*****************************************************************
 *                Private members
 ****************************************************************/
/**
 * @protected
 * @type {boolean}
 */
abview_proto._navigation_delegate = null;

/**
 * @protected
 * @type {boolean}
 */
abview_proto._visible = true;

/**
 * @protected
 * @type {Array}
 */
abview_proto._pos  = null;

/**
 * @protected
 * @type {Array}
 */
abview_proto._size = null;
    
/**
 * @protected
 * @type {ABAnimation}
 */
abview_proto._show_animation = null;
abview_proto.__show_clb = null;

/**
 * @protected
 * @type {ABAnimation}
 */
abview_proto._hide_animation = null;
abview_proto.__hide_clb = null;

/*****************************************************************
 *     Properties declaration
 ****************************************************************/
 
/** 
 *  Set the navigation delegate.
 *  <br/>
 *  The navigation delegate object should implement at least one of
 *  these following methods:
 *  <ul>
 *    <li/>onFocus : function (obj), Called when the view has the focus
 *    <li/>onBlur : function (obj), Called when the view loses the focus
 *    <li/>onBeforeActive : function (obj), Called juste before the view
 *       will be active
 *    <li/>onActive : function (obj), Called when the view is active
 *    <li/>onLeft : function (obj), Called when the view receive a left
 *      key event
 *    <li/>onRight : function (obj), Called when the view receive a right
 *      key event
 *    <li/>onUp : function (obj), Called when the view receive a up
 *      key event
 *    <li/>onDown : function (obj), Called when the view receive a down
 *      key event
 *  </ul>
 *
 *  @example
 *  var myDelagate = new Object ();
 *  function _on_active (obj)
 *  {
 *    // do something
 *  }
 *  myDelagate.onActive = _on_active;
 *
 *  this.myButton.setNavigationDelegate (myDelegate);
 *
 *  @name setNavigationDelegate
 *  @function
 *  @memberOf ABView.prototype
 *
 *  @param {Object} delegate Your delegate object
 */ 
function abview_set_navigationDelegate (v)
{
  this._navigation_delegate = v;
};
abview_proto.setNavigationDelegate = abview_set_navigationDelegate;

/** 
 * Setter for size.
 * <br/>
 * Gives access to the size of the GUI Object
 *
 * @name setSize
 * @function
 * @memberOf ABView.prototype
 *
 * @param {Array.<number>} size the object size
 */ 
function abview_set_size (v)
{
  if (!v) { return; } 
  if (!Object.isArray (v) || v.length != 2) { return; }
  if (!Object.isNumber (v[0]) || !Object.isNumber(v[1])) { return; }

  if (!this.view)
  { 
    this._size [0] = v [0];
    this._size [1] = v [1];
    return;
  }
  
  var border = 2 * __getBorderWidth (this.view);
  this._size [0] = v [0] - border;
  this._size [1] = v [1] - border;
  
  this._updateSize ();
};
abview_proto.setSize = abview_set_size;

/**
 * Getter for size.
 * <br/>
 * Gives access to the size of the GUI Object
 *
 * @name getSize
 * @function
 * @memberOf ABView.prototype
 *
 * @type {Array.<number>}
 */
function abview_get_size ()
{
//  var view = this.view;
/* 
  if (view && view.parentNode)
  {
    this._size [0] = view.offsetWidth;
    this._size [1] = view.offsetHeight;
  }
 */

  return this._size.slice ();
};
abview_proto.getSize = abview_get_size;

/** 
 * Setter for position.
 * <br/>
 * Gives access to the position of the GUI Object
 *
 * @name setPosition
 * @function
 * @memberOf ABView.prototype
 *
 * @type Array
 */ 
function abview_set_position (v)
{
  if (!v) { return; }
  if (!Object.isArray (v) || v.length != 2) { return; }
  if (!Object.isNumber (v[0]) || !Object.isNumber(v[1])) { return; }
  
  this._pos [0] = v [0];
  this._pos [1] = v [1];
  
  if (!this.view) { return; }
  this._updatePos ();
};
abview_proto.setPosition = abview_set_position;

/**
 * Getter for position.
 * <br/>
 * Gives access to the position of the GUI Object
 *
 * @name getPosition
 * @function
 * @memberOf ABView.prototype
 *
 * @type {Array.<number>}
 */
function abview_get_position ()
{
  var view = this.view;
  if (view && view.parentNode)
  {
    this._pos [0] = view.offsetLeft;
    this._pos [1] = view.offsetTop;
  }
  return this._pos.slice ();
};
abview_proto.getPosition = abview_get_position;

/**
 * Hide or show the object.
 * <br/>
 * obj.setVisible (true) <=> obj.show ()
 * obj.setVisible (false) <=> obj.hide (), 
 *
 *  @name setVisible
 *  @function
 *  @memberOf ABView.prototype
 *
 *  @example
 *  myObject.setVisible (false);
 *
 *	@param {Boolean} visibility The visibility can be 'true' or 'false'.
 */
function abview_set_visible (v)
{
  if (v)
  { this.show (); }
  else
  { this.hide (); }
};
abview_proto.setVisible = abview_set_visible;

/**
 * Return true is the object is visible. False otherwise.
 *
 * @name getVisible
 * @function
 * @memberOf ABView.prototype
 *
 * @type {boolean}
 */
function abview_get_visible ()
{
  return this._visible;
};
abview_proto.getVisible = abview_get_visible;

/*****************************************************************
 *
 ****************************************************************/
/**
 * @protected
 */
function abview_destructor ()
{
  var key, a, i, child;
  if (this.__parent)
  {
    this.__parent.remove (this);
  }
  for (key in this.children)
  {
    a = this.children [key];
    if (!a) { continue; }
    
    if (Object.isArray (a))
    {
      for (i = 0; i < a.length; i++)
      {
        child = a [i];
        free (child);
      }
    }
    else
    { free (a); }
    delete (this.children [key]);
  }
  this.children = new Object ();
  delete (this.view);
  
  this.apply ('ABEventSource', 'destructor');
};
abview_proto.destructor = abview_destructor;

/**
 * @protected
 */
function abview_refresh ()
{
  var key, a, i, child;

  for (key in this.children)
  {
    a = this.children [key];
    if (!a) { continue; }
    
    if (Object.isArray (a))
    {
      for (i = 0; i < a.length; i++)
      {
        child = a [i];
        if (!child || !child.refresh) { continue; }
        child.refresh ();
      }
    }
    else if (a.refresh)
    { a.refresh (); }
  }
};
abview_proto.refresh = abview_refresh;

/**
 * @private
 */
function abview__getGUInode (config)
{
  // 1) the node is passed within config object
  if (config.node)
  {
    return config.node;
  }
  
  var node = null, obj;
  // find a direct reference
  if (config.node_id)
  {
    node = document.getElementById (config.node_id);
    if (node) { return node; }
  }    
      
  // last case : find a direct reference with component id 
  if (config.id)
  {
    node = document.getElementById (config.id);
    if (node) { return node; }
  }
  
  return undefined;
};
abview_proto._getGUInode = abview__getGUInode;
  
/**
 *  Init the GUI object.
 *  <p>
 *  This method should be implemented by all object inheriting from a
 *  ABView class. See the programer's guide for more information.
 *
 * @name init
 * @function
 * @memberOf ABView.prototype
 *
 *  @example
 *  var myObject = new ABView (config);
 *  myObject.init ();
 *  // now myObject is completely built and can be used
 */
function abview_init ()
{
  this.apply ('ABEventSource', 'init');
  
  this.initSkin ();
};
abview_proto.init = abview_init;

function __view_focus ()
{
  var e = document.currentEvent;
  if (e && e.target && e.target._comp_)
  {
    e.target._comp_._onFocus ();
  }
}

function __view_blur ()
{
  var e = document.currentEvent;
  if (e && e.target && e.target._comp_)
  {
    e.target._comp_._onBlur ();
  }
}

/**
 *
 * @name initSkin
 * @function
 * @memberOf ABView.prototype
 *
 */
function abview_initSkin (passSizeAndPosInit)
{
  var view = this.view;
  // if the object has view, init size and position
  // Becareful, size and position initialization take time
  if (!passSizeAndPosInit && view)
  {
    this._size [0] = view.offsetWidth;
    this._size [1] = view.offsetHeight;
    this._pos [0] = view.offsetLeft;
    this._pos [1] = view.offsetTop;
  }
  else
  {
    this._pos = new Array (2); this._pos [0] = -1; this._pos [1] = -1;
    this._size = new Array (2); this._size [0] = -1; this._size [1] = -1;
  }
/*
  var self = this;
  this.view.onFocus = __view_focus;
  this.view.onBlur = __view_blur;
*/
};
abview_proto.initSkin = abview_initSkin;

/**
 * @private
 */
function abview__parse_view (node)
{
  if (!node || node.nodeType == 3) { return; }

  var hole_attribute, child;
  
  if (node.attributes != null)
  {
    hole_attribute = node.attributes.getNamedItem ("x-hag-hole");
    if (hole_attribute)
    {
      this._holes [hole_attribute.nodeValue] = node;
      return; // hole can not include hode
    }
  }
  
  child = node.firstElementChild;
  while (child)
  {
    this._parse_view (child);
    child = child.nextElementSibling;
  }
};
abview_proto._parse_view = abview__parse_view;

/**
 * @private
 */
function abview__instrument_view (node)
{
};
abview_proto._instrument_view = abview__instrument_view;

function abview__onFocus ()
{
  Page._current_focus_comp = this;
  
  if (this._navigation_delegate && this._navigation_delegate.onFocus)
  {
    this._navigation_delegate.onFocus (this);
  }
};
abview_proto._onFocus = abview__onFocus;

function abview__onBlur ()
{
  if (this._navigation_delegate && this._navigation_delegate.onBlur)
  {
    this._navigation_delegate.onBlur (this);
  }
};
abview_proto._onBlur = abview__onBlur

function abview__onUp ()
{
  if (this._navigation_delegate && this._navigation_delegate.onUp)
  {
    this._navigation_delegate.onUp (this);
  }
};
abview_proto._onUp = abview__onUp

function abview__onDown ()
{
  if (this._navigation_delegate && this._navigation_delegate.onDown)
  {
    this._navigation_delegate.onDown (this);
  }
};
abview_proto._onDown = abview__onDown;

function abview__onLeft ()
{
  if (this._navigation_delegate && this._navigation_delegate.onLeft)
  {
    this._navigation_delegate.onLeft (this);
  }
};
abview_proto._onLeft = abview__onLeft;

function abview__onRight ()
{
  if (this._navigation_delegate && this._navigation_delegate.onRight)
  {
    this._navigation_delegate.onRight (this);
  }
};
abview_proto._onRight = abview__onRight;

function abview__onBeforeActive ()
{
  if (this._navigation_delegate && this._navigation_delegate.onBeforeActive )
  {
    this._navigation_delegate.onBeforeActive (this);
  }
};
abview_proto._onBeforeActive = abview__onBeforeActive;

function abview__onActive ()
{
  if (this._navigation_delegate && this._navigation_delegate.onActive)
  {
    this._navigation_delegate.onActive (this);
  }
};
abview_proto._onActive = abview__onActive;

/**
 * @private
 */
function abview_notify (event)
{
};
abview_proto.notify = abview_notify;

/**
 *  Return true if the set component is a child o the current component
 *
 *  @name isChild
 *  @function
 *  @memberOf ABView.prototype
 *
 *	@param {ABEventSource} child The component to be removed.
 *	@return {boolean}
 */
function abview_isChild (child)
{
  if (!child) { return false; }
  
  var key, a, hole;
  
  for (key in this.children)
  {
    a = this.children [key];
    if (!a) { continue; }
    
    if (a == child || (Object.isArray (a) && a.indexOf (child) != -1))
    {
      return true;
    }
  }

  return false;
};
abview_proto.isChild = abview_isChild;

/**
 * @private
 */
function abview_add_object (child, extension, view)
{
  if (!child) { return; }
  if (!view) { view = child.view; }
  else { child.__gui_object__hack_view__ = view; }
  
  if (this.isChild (child)) { return; }
  
  var key, a, b, hole;
  if (!view)
  { key = ABView.NON_G_OBJECT; }
  // a non graphical object
  else if (!extension)
  { key = ABView.ANY_PLACE; }
  else
  { key = extension; }
  
  a = this.children [key];
  if (a && Object.isArray (a))
  { a [a.length] = child; }
  else if (a)
  {
    b = new Array ();
    b [0] = a;
    b [1] = child;
    this.children [key] = b;
  }
  else
  { this.children [key] = child; }
  
  child.__parent = this;
// 
//   hole = this._holes [key];
//   if (view && hole)
//   {
//     if (view.parentNode)
//     {
//       if (view.parentNode == hole)
//       {
//         child.__parent = this;
//         return;
//       }
//       view.parentNode.removeChild (view);
//     }
//     hole.appendChild (view);
//     child.__parent = this;
//   }
};
abview_proto.add_object = abview_add_object;

/**
 *  Add the specified child component to this component.
 *  <p>
 *  The component can be a graphic component (ABView) or
 *  a non graphic component (ABEventSource).
 *  In case of ABView its mandatory to set the extension.
 *  <p>
 *  The add is a lazy add! The child's view can be already in
 *  the HTML DOM. In that case, the add methode do not modify the DOM.
 *  <p>
 *
 *  @name add
 *  @function
 *  @memberOf ABView.prototype
 *
 *  @example
 *  var myButton = new Button (conf);
 *  myObject.add (myButton, 'children');
 *
 *	@param {ABEventSource} child The component to be added.
 *	@param {String} extension [optional] The hole into a ABView will be insert.
*/
function abview_add (child, extension)
{
  this.add_object (child, extension);
};
abview_proto.add = abview_add;

/**
 * @private
 */
function abview_remove_object (child)
{
  if (!child) { return; }
  
  var key, a, hole, view;
  
  if (child.__gui_object__hack_view__)
  {
    view = child.__gui_object__hack_view__;
  }
  else { view = child.view; }
  
  if (view)
  {
    for (key in this.children)
    {
      a = this.children [key];
      if (!a) { continue; }
      
      if (a == child || (Object.isArray (a) && a.indexOf (child) != -1))
      {
        if (Object.isArray (a)) {a.remove (child);}
        else { delete (this.children [key]); }
        
        hole = this._holes [key];
        if (hole) { hole.removeChild (view); }
        
        child.__parent = null;
        break;
      }
    }
  }
};
abview_proto.remove_object = abview_remove_object;
  
/**
 *  Remove the specified child component from this component.
 * 
 *  @name remove
 *  @function
 *  @memberOf ABView.prototype
 *
 *  @example
 *  myObject.remove (myButton);
 *
 *	@param {ABEventSource} child The component to be removed.
*/
function abview_remove (child)
{
  this.remove_object (child);
};
abview_proto.remove = abview_remove;

/**
 *  Remove all children components from this component and free them.
 *
 *  @name removeAllChildren
 *  @function
 *  @memberOf ABView.prototype
 *
 *  @example
 *  myObject.removeAllChildren ();
 */
function abview_removeAllChildren ()
{
  var key, a, child;

  for (key in this.children)
  {
    a = this.children [key];
    if (!a) { continue; }
    
    if (Object.isArray (a))
    {
      while (a.length)
      {
        child = a [0];
        this.remove (child);
        free (child);
      }
    }
    else
    {
      this.remove (a);
      free (a);
    }
    delete (this.children [key]);
  }
  this.children = new Object ();
};
abview_proto.removeAllChildren = abview_removeAllChildren;

/********************************************************************
                GUI Utilities
********************************************************************/

/**
 * @private
 */
function abview__updateSizeAndPos ()
{
};
abview_proto._updateSizeAndPos = abview__updateSizeAndPos;

/**
 * @private
 */
function abview__updateSize ()
{
  __setSize (this.view, this._size [0], this._size [1])
};
abview_proto._updateSize = abview__updateSize;

/**
 * @private
 */
function abview__updatePos ()
{
  __setPos (this.view, this._pos [0], this._pos [1]);
};
abview_proto._updatePos = abview__updatePos;

/********************************************************************
                
********************************************************************/

/**
 *  Displays the GUI Object
 *
 *  @name show
 *  @function
 *  @memberOf ABView.prototype
 *
 */
function abview_show ()
{
  if (!this.view) { return; }
  if (this._visible) { return; }
  
  __setVisible (this.view, true);

  if (this._show_animation)
  {
    this._show_animation.process (this, this._show_object, this);
  }
  else
  {
    this._show_object ();
  }
};
abview_proto.show = abview_show;

/**
 *  Show the GUI Object
 *
 *  @private
 */
function abview__show_object ()
{
  if (!this.view) { return; }

  this._visible = true;
  
/*
  _propagate (this.id);

  if (this.__show_clb)
  {
    if (this._show_animation)
    { this.__show_clb.call (this); }
    else
    {
      var self = this;
      setTimeout (function () {self.__show_clb.call (self);}, 0);
    }
  }
*/
};
abview_proto._show_object = abview__show_object;

/**
 *  Hides the GUI Object
 *
 *  @name hide
 *  @function
 *  @memberOf ABView.prototype
 *
 */
function abview_hide ()
{
  if (!this.view) { return; }
  if (!this._visible) { return; }

  if (this._hide_animation)
  {
    this._hide_animation.process (this, this._hide_object, this);
  }
  else
  {
    this._hide_object ();
  }
};
abview_proto.hide = abview_hide;

/**
 *  Hides the GUI Object
 *
 *  @private
 */
function abview__hide_object ()
{
  if (!this.view) { return; }

  this._visible = false;
  
  __setVisible (this.view, false);
//  _propagate (this.id);
};
abview_proto._hide_object = abview__hide_object;

/********************************************************************
                
********************************************************************/
/**
 *  Set the focus to this widget.
 *   <br/>
 *  If you manage by your self the focus, the application will not receive
 *  anymore the TV control events.<br/>
 *  You will have to manage them by your self
 *  or give back the focus to the application.
 *  @see Page#setFocus
 *  
 *  @name setFocus
 *  @function
 *  @memberOf ABView.prototype
 *
 * @public
 */
function abview_setFocus ()
{
  if (!this.view)
  { return; }
  
  browser.lockScreen ();
/*  this.view.focus (); */
  if (Page._current_focus_comp)
  {
    Page._current_focus_comp._onBlur ();
  }
  this._onFocus ();
  browser.unlockScreen ();
}
abview_proto.setFocus = abview_setFocus;

var ABView = Class.create ('ABView', abview_proto);
Class.extend ('ABView', 'ABEventSource');

/********************************************************************
                    
*********************************************************************/

/**
 * @private
 */
ABView.NON_G_OBJECT = '_non_g_object';
/**
 * @private
 */
ABView.ANY_PLACE = 'children';
/**
 * @private
 */
ABView._positionStyle = undefined;/**
 Copyright (C) 2009-2011. ViniSketch SARL - David Thevenin

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

/**
 * @private
 */
var abtextlabel_proto = new Object ();

/**
 *  ABTextLabel class. <br/>
 *  Default constructor of the ABTextView.
 *  @example
 *  var config = new Object ();
 *  config.id = "textId";
 *  var myText = Class["new"] ("ABTextView", config);
 *  myText.init ();
 *  myText.setText ("Hello World!");
 *
 *  @extends ABView
 *  @class
 *  An text view object display a text. You can custom the text color, font 
 *  size... using css styling. 
 *
 *  @name ABTextLabel
 *  @constructor
 */
function abtextlabel_constructor (config)
{
  this.apply ('ABView', '_constructor', config);
}
abtextlabel_proto._constructor = abtextlabel_constructor;

/**
 * The text value
 * @protected
 * @type {string}
 */
abtextlabel_proto._text = "";

/*****************************************************************
 *
 ****************************************************************/

/**
 *  Set the text value
 *
 *  @name setText
 *  @function
 *  @memberOf ABTextLabel.prototype
 *
 * @param {string} text the text value
 */
function abtextlabel_set_text (v)
{
  if (typeof (v) == "undefined") { v = ''; }
  else if (Object.isNumber (v)) { v = '' + v; }
  else if (!Object.isString (v))
  {
    if (!v.toString) { return; }
    v = v.toString ();
  }
  
  this._text = v;
  __setInnerText (this.view, this._text);
}
abtextlabel_proto.setText = abtextlabel_set_text;

/**
 * Return the text value
 *
 *  @name getText
 *  @function
 *  @memberOf ABTextLabel.prototype
 *
 * @return {string}
 */
function abtextlabel_get_text ()
{
  return this._text;
}
abtextlabel_proto.getText = abtextlabel_get_text;

/*****************************************************************
 *
 ****************************************************************/

/**
 *
 *  @name initSkin
 *  @function
 *  @memberOf ABTextLabel.prototype
 *
 * @protected
 */
function abtextlabel_initSkin ()
{
  this.apply ('ABView', 'initSkin');
  if (!this._text) { return; }
  
  __setInnerText (this.view, this._text);
}
abtextlabel_proto.initSkin = abtextlabel_initSkin;

var ABTextLabel = Class.create ('ABTextLabel', abtextlabel_proto);
Class.extend ('ABTextLabel', 'ABView');
/**
 Copyright (C) 2009-2011. ViniSketch SARL - David Thevenin

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

/**
 * @private
 */
var abnavtextlabel_proto = new Object ();

/**
 *  ABNavTextLabel class. <br/>
 *  Default constructor of the ABNavTextLabel.
 *  @example
 *  var config = new Object ();
 *  config.id = "textId";
 *  var myText = Class["new"] ("ABNavTextLabel", config);
 *  myText.init ();
 *  myText.setText ("Hello World!");
 *  myText.setFocusText ("I have the focus");
 *  myText.setActiveText ("I am active");
 *
 *  @extends ABView
 *  @class
 *  A navigation text provides a view for displaying three states text.
 *  <br /><br />
 *  A navigation view is a view that implements by default three states:
 *  default, focus and active, and mangage three different views (and CSS style) 
 *  for each states. According the user interaction, the view will switch
 *  between states and state's views.
 *  <br />
 *  You can custom each state's text color, font size... using css styling. 
 *  <br />
 *  The id of each state view is: {comp.id}_[d/f/a]
 *
 *  @name ABNavTextLabel
 *  @constructor
 */
function abnavtextlabel_constructor (config)
{
  this.apply ('ABView', '_constructor', config);
}
abnavtextlabel_proto._constructor = abnavtextlabel_constructor;

/**
 * The text value
 * @protected
 * @type {string}
 */
abnavtextlabel_proto._text = "";

/**
 * The text when the width has focus
 * @protected
 * @type {string}
 */
abnavtextlabel_proto._focus_text = null;

/**
 * The text when the width is active
 * @protected
 * @type {string}
 */
abnavtextlabel_proto._active_text = null;

/**
 * The default view
 * @protected
 * @type {HtmlPElement}
 */
abnavtextlabel_proto._default_view = null;

/**
 * The focus view
 * @protected
 * @type {HtmlPElement}
 */
abnavtextlabel_proto._focus_view = null;

/**
 * The active view
 * @protected
 * @type {HtmlPElement}
 */
abnavtextlabel_proto._active_view = null;

/*****************************************************************
 *
 ****************************************************************/
 
/**
 *  Set the text label view size
 *
 *  @name setSize
 *  @function
 *  @memberOf ABNavTextLabel.prototype
 *
 *
 * @param {Array<number>} array 
 */
function abnavtextlabel_set_size (v)
{
  if (!Object.isArray (v) && v.length != 2)
  {
    if (!Object.isNumber (v[0]) || !Object.isNumber(v[1])) { return; }
  }
  this.apply ('ABView', 'setSize', v);
  
  __setSize (this._default_view, this._size[0], this._size[1]);
  __setSize (this._focus_view, this._size[0], this._size[1]);
  __setSize (this._active_view, this._size[0], this._size[1]);
}
abnavtextlabel_proto.setSize = abnavtextlabel_set_size;

/**
 * Set the text value
 *
 *  @name setText
 *  @function
 *  @memberOf ABNavTextLabel.prototype
 *
 * @param {string} text The text value
 */
function abnavtextlabel_set_text (v)
{
  if (typeof (v) == "undefined") { v = ''; }
  else if (Object.isNumber (v)) { v = '' + v; }
  else if (!Object.isString (v))
  {
    if (!v.toString) { return; }
    v = v.toString ();
  }
  
  this._text = v;
  __setInnerText (this._default_view, this._text);
  if (!Object.isString (this._focus_text))
  {
    __setInnerText (this._focus_view, this._text);
  }
  if (!Object.isString (this._active_text))
  {
    __setInnerText (this._active_view, this._text);
  }
}
abnavtextlabel_proto.setText = abnavtextlabel_set_text;

/**
 *  Returns the text value
 *
 *  @name getText
 *  @function
 *  @memberOf ABNavTextLabel.prototype
 *
 * @return {string}
 */
function abnavtextlabel_get_text ()
{
  return this._text;
}
abnavtextlabel_proto.getText = abnavtextlabel_get_text;

/**
 *  The text when the widget has the focus
 *
 *  @name setFocusText
 *  @function
 *  @memberOf ABNavTextLabel.prototype
 *
 * @param {string} text The text value
 */
function abnavtextlabel_set_focus_text (v)
{
  if (typeof (v) == "undefined") { v = ''; }
  else if (Object.isNumber (v)) { v = '' + v; }
  else if (!Object.isString (v))
  {
    if (!v.toString) { return; }
    v = v.toString ();
  }
  
  this._focus_text = v;
  __setInnerText (this._focus_view, this._focus_text);
}
abnavtextlabel_proto.setFocusText = abnavtextlabel_set_focus_text;

/**
 *  Returns the text value
 *
 *  @name getFocusText
 *  @function
 *  @memberOf ABNavTextLabel.prototype
 *
 * @return {string}
 */
function abnavtextlabel_get_focus_text ()
{
  return this._focus_text;
}
abnavtextlabel_proto.getFocusText = abnavtextlabel_set_focus_text;

/**
 *  The text when the widget is active
 *
 *  @name setActiveText
 *  @function
 *  @memberOf ABNavTextLabel.prototype
 *
 * @param {string} text The text value
 */
function abnavtextlabel_set_active_text (v)
{
  if (typeof (v) == "undefined") { v = ''; }
  else if (Object.isNumber (v)) { v = '' + v; }
  else if (!Object.isString (v))
  {
    if (!v.toString) { return; }
    v = v.toString ();
  }
  
  this._active_text = v;
  __setInnerText (this._active_view, this._active_text);
}
abnavtextlabel_proto.setActiveText = abnavtextlabel_set_active_text;

/**
 *  Returns the text value
 *
 *  @name getActiveText
 *  @function
 *  @memberOf ABNavTextLabel.prototype
 *
 * @return {string}
 */
function abnavtextlabel_get_active_text ()
{
  return this._active_text;
}
abnavtextlabel_proto.getActiveText = abnavtextlabel_get_active_text;

/*****************************************************************
 *
 ****************************************************************/

/**
 * @protected
 */
function abnavtextlabel_destructor ()
{
  delete (this._default_view);
  delete (this._focus_view);
  delete (this._active_view);
  
  this.apply ('ABView', 'destructor');
}
abnavtextlabel_proto.destructor = abnavtextlabel_destructor;

function abnavtextlabel__onFocus ()
{
  __setVisible (this._default_view, false);
  __setVisible (this._focus_view, true);
  __setVisible (this._active_view, false);
  
  this.apply ('ABView', '_onFocus');
}
abnavtextlabel_proto._onFocus = abnavtextlabel__onFocus;

function abnavtextlabel__onBlur ()
{
  __setVisible (this._default_view, true);
  __setVisible (this._focus_view, false);
  __setVisible (this._active_view, false);
  
  this.apply ('ABView', '_onBlur');
}
abnavtextlabel_proto._onBlur = abnavtextlabel__onBlur;

function abnavtextlabel__onBeforeActive ()
{
  __setVisible (this._default_view, false);
  __setVisible (this._focus_view, false);
  __setVisible (this._active_view, true);
  
  this.apply ('ABView', '_onBeforeActive');
}
abnavtextlabel_proto._onBeforeActive = abnavtextlabel__onBeforeActive;

function abnavtextlabel__onActive ()
{
  __setVisible (this._default_view, false);
  __setVisible (this._focus_view, true);
  __setVisible (this._active_view, false);
  
  this.apply ('ABView', '_onActive');
}
abnavtextlabel_proto._onActive = abnavtextlabel__onActive;

/**
 *
 *  @name initSkin
 *  @function
 *  @memberOf ABNavTextLabel.prototype
 *
 * @protected
 */
function abnavtextlabel_initSkin ()
{
  this.apply ('ABView', 'initSkin');
  
  if (this.view)
  {
    var child = this.view.firstChild;
    while (child && __getTagName (child) != 'p' && 
          __getTagName (child) != 'P')
    { child = child.nextSibling; }
    
    if (!child)
    {
      printlnConsole ("ERROR ABNavTextLabel.initSkin 1");
      return;
    }
    this._default_view = child;

    child = child.nextSibling;
    while (child && __getTagName (child) != 'p' && 
          __getTagName (child) != 'P')
    { child = child.nextSibling; }
    
    if (!child)
    {
      printlnConsole ("ERROR ABNavTextLabel.initSkin 2");
      return;
    }
    this._focus_view = child;

    child = child.nextSibling;
    while (child && __getTagName (child) != 'p' && 
          __getTagName (child) != 'P')
    { child = child.nextSibling; }
    
    if (!child)
    {
      printlnConsole ("ERROR ABNavTextLabel.initSkin 3");
      return;
    }
    this._active_view = child;
  }
}
abnavtextlabel_proto.initSkin = abnavtextlabel_initSkin;

var ABNavTextLabel = Class.create ('ABNavTextLabel', abnavtextlabel_proto);
Class.extend ('ABNavTextLabel', 'ABView');
/**
 Copyright (C) 2009-2011. ViniSketch SARL - David Thevenin

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

/**
 * @private
 */
var abnavimageview_proto = new Object ();

/**
 *  ABNavImageView class. <br/>
 *  Default constructor of the ABNavImageView.
 *  @example
 *  var config = new Object ();
 *  config.id = "imageId";
 *  var myImage = Class["new"] ("ABNavImageView", config);
 *  myImage.init ();
 *
 *  @extends ABView
 *  @class
 *  An navigation image view object provides a view-based container for
 *  displaying three states image. <br /><br />
 *  A navigation view is a view that implements by default three states:
 *  default, focus and active, and mangage three different views (and CSS style) 
 *  for each states. According the user interaction, the view will switch
 *  between states and state's views.
 *  <br/>
 *  As ABImageView, the images references by the ABNavImageVice can be a JPEG
 * image or a PNG image. Each type of image has there own limitations: <ul>
 *    <li /> PNG. Has to be an indexed color PNG, and the table of colors
 *      (CLUT) has to be load before (please refer to the BML documentation
 *      for more information).
 *    <li /> JPEG. The size of the image has to twice of the
 *      wanted size. For instance if you want draw a 100px per 100px image
 *      you have to set a 200px per 200px jpeg image.
 *  </ul>
 *  For both it is impossible to resize the image. If you resize the  ImageView
 *  It will crop the image.
 *
 *  @name ABNavImageView
 *  @constructor
 */
function abnavimageview_constructor (config)
{
  this.apply ('ABView', '_constructor', config);
  
  // init default image src with the attribute node img.src
  // if it exists. Use getAttribute instead of direct property
  // in order to have a relative path (without base)
  if (this._default_view)
  { this._src = this._default_view.data; }
  if (this._active_view)
  { this._active_src = this._active_view.data; }
  if (this._focus_view)
  { this._focus_src = this._focus_view.data; }
}
abnavimageview_proto._constructor = abnavimageview_constructor;

/**
 * The image url
 * @private
 * @type {string}
 */
abnavimageview_proto._src = '';
abnavimageview_proto._focus_src = '';
abnavimageview_proto._active_src = '';

/*****************************************************************
 *
 ****************************************************************/

/**
 *  Set the default image source url
 *
 *  @name setSrc
 *  @function
 *  @memberOf ABNavImageView.prototype
 *
 * @param {string} url image url path
 */
function abnavimageview_set_src (v)
{
  if (!Object.isString (v)) { return; }
  this._src = v;
  
  if (this._default_view)
  {
    this._default_view.data = this._src;
  }
}
abnavimageview_proto.setSrc = abnavimageview_set_src;

/**
 *  Returns the default image source url
 *
 *  @name getSrc
 *  @function
 *  @memberOf ABNavImageView.prototype
 *
 * @return {string} image url path
 */
function abnavimageview_get_src ()
{
  return this._src;
}
abnavimageview_proto.getSrc = abnavimageview_get_src;

/**
 *  Set the focus image source url
 *
 *  @name setFocusSrc
 *  @function
 *  @memberOf ABNavImageView.prototype
 *
 * @param {string} url image url path
 */
function abnavimageview_set_focus_src (v)
{
  if (!Object.isString (v)) { return; }
  this._focus_src = v;
  
  if (this._focus_view)
  {
    this._focus_view.data = this._focus_src;
  }
}
abnavimageview_proto.setFocusSrc = abnavimageview_set_focus_src;

/**
 *  Returns the focus image source url
 *
 *  @name getFocusSrc
 *  @function
 *  @memberOf ABNavImageView.prototype
 *
 * @return {string} image url path
 */
function abnavimageview_get_focus_src ()
{
  return this._focus_src;
}
abnavimageview_proto.getFocusSrc = abnavimageview_get_focus_src;

/**
 *  Set the active image source url
 *
 *  @name setActiveSrc
 *  @function
 *  @memberOf ABNavImageView.prototype
 *
 * @param {string} url image url path
 */
function abnavimageview_set_active_src (v)
{
  if (!Object.isString (v)) { return; }
  this._active_src = v;
  
  if (this._active_view)
  {
    this._active_view.data = this._active_src;
  }
}
abnavimageview_proto.setActiveSrc = abnavimageview_set_active_src;

/**
 *  Returns the active image source url
 *
 *  @name getActiveSrc
 *  @function
 *  @memberOf ABNavImageView.prototype
 *
 * @return {string} image url path
 */
function abnavimageview_get_active_src ()
{
  return this._active_src;
}
abnavimageview_proto.getActiveSrc = abnavimageview_get_active_src;

/**
 *  Set the image view size
 *
 *  @name setSize
 *  @function
 *  @memberOf ABNavImageView.prototype
 *
 *
 * @param {Array<number>} array 
 */
function abnavimageview_set_size (v)
{
  if (!Object.isArray (v) && v.length != 2)
  {
    if (!Object.isNumber (v[0]) || !Object.isNumber(v[1])) { return; }
  }
/* 
  if (this.view)
  {
    this.view.setAttribute ('width', v [0]);
    this.view.setAttribute ('height', v [1]);
  }
 */

  this._size [0] = v [0];
  this._size [1] = v [1];
//  this._updateSize ();
}
abnavimageview_proto.setSize = abnavimageview_set_size;

/**
 *  Returns the image view size
 *
 *  @name getSize
 *  @function
 *  @memberOf ABNavImageView.prototype
 *
 * @return {Array.<number>} array of image's width and height
 */
function abnavimageview_get_size ()
{
  if (this.view && this.view.parentNode)
  {
    this._size [0] = this.view.offsetWidth;
    this._size [1] = this.view.offsetHeight;
  }
  return this._size.slice ();
}
abnavimageview_proto.getSize = abnavimageview_get_size;

/*****************************************************************
 *
 ****************************************************************/  

/**
 * @private
 */
function abnavimageview__onFocus ()
{
  __setVisible (this._default_view, false);
  __setVisible (this._focus_view, true);
  __setVisible (this._active_view, false);
  
  this.apply ('ABView', '_onFocus');
}
abnavimageview_proto._onFocus = abnavimageview__onFocus;

/**
 * @private
 */
function abnavimageview__onBlur ()
{
  __setVisible (this._default_view, true);
  __setVisible (this._focus_view, false);
  __setVisible (this._active_view, false);
  
  this.apply ('ABView', '_onBlur');
}
abnavimageview_proto._onBlur = abnavimageview__onBlur;

/**
 * @private
 */
function abnavimageview__onBeforeActive ()
{
  __setVisible (this._default_view, false);
  __setVisible (this._focus_view, false);
  __setVisible (this._active_view, true);
  
  this.apply ('ABView', '_onBeforeActive');
}
abnavimageview_proto._onBeforeActive = abnavimageview__onBeforeActive;

/**
 * @private
 */
function abnavimageview__onActive ()
{
  __setVisible (this._default_view, false);
  __setVisible (this._focus_view, true);
  __setVisible (this._active_view, false);
  
  this.apply ('ABView', '_onActive');
}
abnavimageview_proto._onActive = abnavimageview__onActive;

/*****************************************************************
 *
 ****************************************************************/  

/**
 *
 *  @name initSkin
 *  @function
 *  @memberOf ABNavImageView.prototype
 *
 * @protected
 */
function abnavimageview_initSkin ()
{
  this.apply ('ABView', 'initSkin');

  if (this.view)
  {
    var child = this.view.firstChild;
    while (child && __getTagName (child) != 'object' && 
          __getTagName (child) != 'OBJECT')
    { child = child.nextSibling; }
    
    if (!child)
    {
      printlnConsole ("ERROR ABNavImageView.initSkin 1");
      return;
    }
    this._default_view = child;

    child = child.nextSibling;
    while (child && __getTagName (child) != 'object' && 
          __getTagName (child) != 'OBJECT')
    { child = child.nextSibling; }
    
    if (!child)
    {
      printlnConsole ("ERROR ABNavImageView.initSkin 2");
      return;
    }
    this._focus_view = child;

    child = child.nextSibling;
    while (child && __getTagName (child) != 'object' && 
          __getTagName (child) != 'OBJECT')
    { child = child.nextSibling; }
    
    if (!child)
    {
      printlnConsole ("ERROR ABNavImageView.initSkin 3");
      return;
    }
    this._active_view = child;

    __setVisible (this._default_view, true);
    __setVisible (this._focus_view, false);
    __setVisible (this._active_view, false);
  }
}
abnavimageview_proto.initSkin = abnavimageview_initSkin;

var ABNavImageView = Class.create ('ABNavImageView', abnavimageview_proto);
Class.extend ('ABNavImageView', 'ABView');
/**
 Copyright (C) 2009-2011. ViniSketch SARL - David Thevenin

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

/**
 * @private
 */
var abimageview_proto = new Object ();

/**
 *  ABImageView class. <br/>
 *  Default constructor of the ABImageView.
 *  @example
 *  var config = new Object ();
 *  config.id = "imageId";
 *  var myImage = Class["new"] ("ABImageView", config);
 *  myImage.init ();
 *
 *  @extends ABView
 *  @class
 *  An image view object provides a view-based container for displaying
 *  a single image.
 *  <br/>
 *  A Image can be a JPEG image or a PNG image. Each type of image
 *  has there own limitations:
 *  <ul>
 *    <li /> PNG. Has to be an indexed color PNG, and the table of colors
 *      (CLUT) has to be load before (please refer to the BML documentation
 *      for more information).
 *    <li /> JPEG. The size of the image has to twice of the
 *      wanted size. For instance if you want draw a 100px per 100px image
 *      you have to set a 200px per 200px jpeg image.
 *  </ul>
 *  For both it is impossible to resize the image. If you resize the  ImageView
 *  It will crop the image.
 *
 *  @name ABImageView
 *  @constructor
 */
function abimageview_constructor (config)
{
  this.apply ('ABView', '_constructor', config);
  
  // init default image src with the attribute node img.src
  // if it exists. Use getAttribute instead of direct property
  // in order to have a relative path (without base)
  if (this.view && this.view.data)
  {
    this._src = this.view.data;
  }
}
abimageview_proto._constructor = abimageview_constructor;

/**
 * The image url
 * @private
 * @type {string}
 */
abimageview_proto._src = null;

abimageview_proto._img_view = null;

/*****************************************************************
 *
 ****************************************************************/

/**
 * Set the image url
 *
 *  @name setSrc
 *  @function
 *  @memberOf ABImageView.prototype
 *
 **  @param {String} url the image url
 */
function abimageview_set_src (v)
{
  if (!Object.isString (v)) { return; }
  
  this._src = v;
  
  if (this._img_view)
  {
    this._img_view.data = this._src;
  }
}
abimageview_proto.setSrc = abimageview_set_src;

/**
 *  Get the image url
 *
 *  @name getSrc
 *  @function
 *  @memberOf ABImageView.prototype
 *
 * @return {string}
 */
function abimageview_get_src ()
{
  return this._src;
}
abimageview_proto.getSrc = abimageview_get_src;

/**
 *  Set the image size
 *
 *  @name setSize
 *  @function
 *  @memberOf ABImageView.prototype
 *
 *
 *  @param {Array.<number>} size the object size
 */
function abimageview_set_size (v)
{
  if (!Object.isArray (v) && v.length != 2)
  {
    if (!Object.isNumber (v[0]) || !Object.isNumber(v[1])) { return; }
  }

  this._size [0] = v [0];
  this._size [1] = v [1];
//  this._updateSize ();
}
abimageview_proto.setSize = abimageview_set_size;

/**
 *  Returns the images size
 *
 *  @name getSize
 *  @function
 *  @memberOf ABImageView.prototype
 *
 * @return {Array.<number>}
 */
function abimageview_get_size ()
{
  // @TODO use normalStyle
  return this._size.slice ();
}
abimageview_proto.getSize = abimageview_get_size;

/*****************************************************************
 *
 ****************************************************************/  

/**
 *
 *  @name initSkin
 *  @function
 *  @memberOf ABImageView.prototype
 *
 * @protected
 */
function abimageview_initSkin ()
{
  this.apply ('ABView', 'initSkin');

  if (this.view)
  {
    this._img_view = this.view;
  }

  this._src = this._img_view.data;
}
abimageview_proto.initSkin = abimageview_initSkin;

var ABImageView = Class.create ('ABImageView', abimageview_proto);
Class.extend ('ABImageView', 'ABView');
/**
 Copyright (C) 2009-2011. ViniSketch SARL - David Thevenin

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
 
 Use code from Canto.js Copyright 2010 David Flanagan
*/

/**
 * @private
 */
var abvideo_proto = new Object ();

/**
 *  The ABVideo class
 *
 *  @extends ABView
 *  @class
 *  The ABVideo class allow to show a movie clip or other video streams.
 *  <p>
 *  Events:
 *  <ul>
 *  </ul>
 *  <p>
 * The delegate has to implement:
 *  <ul>
 *  </ul>
 *  @author David Thevenin
 *
 *  @constructor
 *   Creates a new ABVideo.
 *
 *  @example
 *   myVideo.src = "http://yourlink.mp4";
 *   myVideo.play ();
 *
 *  @name ABVideo
 *	@param {Object} config The configuration stucture [mandatory]
*/
function abvideo_constructor (config)
{
  this.apply ('ABView', '_constructor', config);
}
abvideo_proto._constructor = abvideo_constructor;

/*****************************************************************
 *
 ****************************************************************/
 
/**
 * @protected
 * @type {string}
 */
abvideo_proto._src = "";

/**
 * @protected
 * @type {boolean}
 */
abvideo_proto._autoplay = false;

/**
 * @protected
 * @type {boolean}
 */
abvideo_proto._loop = false;

/**
 * @protected
 * @type {Object}
 */
abvideo_proto.__video_node = null;

/**
 * @protected
 * @type {boolean}
 */
abvideo_proto.__is_playing = false;

/*****************************************************************
 *     Properties declaration
 ****************************************************************/

/**
 *  Defines the video url
 *
 *  @name setSrc
 *  @function
 *  @memberOf ABVideo.prototype
 *
 * @name ABVideo#src 
 * @type {string}
 */
function abvideo_setSrc (v)
{
  if (!Object.isString (v)) { return; }
  
  this._src = v;
  
  if (!this.__video_node) { return; }
  if (this.__is_playing)
  { this.__video_node.streamStatus = "stop"; }
  this.__video_node.data = this._src;
  if (this.__is_playing)
  { this.__video_node.streamStatus = "play"; }

//    _propagate (this.id, 'src');
};
abvideo_proto.setSrc = abvideo_setSrc;

/**
 *  Return the url of the video
 *
 *  @name getSrc
 *  @function
 *  @memberOf ABVideo.prototype
 *
 * @name ABVideo#src 
 * @type {string}
 */
function abvideo_getSrc ()
{
  return this._src;
};
abvideo_proto.getSrc = abvideo_getSrc;

/**
 *  The loop property indicates that the media element is to seek back to
 *  the start of the media resource upon reaching the end.
 *
 *  @name setLoop
 *  @function
 *  @memberOf ABVideo.prototype
 *
 *  @name ABVideo#loop 
 *  @param {boolean} bool is the video play in loop or not
 */
function abvideo_setLoop (v)
{
  if (v) { this._loop = true; }
  else { this._loop = false; }
  
  if (!this.__video_node) { return; }
  if (this._loop)
  { this.__video_node.streamlooping = 1; }
  else
  { this.__video_node.streamlooping = 0; }
  
//  _propagate (this.id, 'loop');
};
abvideo_proto.setLoop = abvideo_setLoop;

/**
 *  Returns true if the video play in loop.
 *
 *  @name getLoop
 *  @function
 *  @memberOf ABVideo.prototype
 *
 *  @return {boolean}
 */
function abvideo_getLoop ()
{
  return this._loop;
};
abvideo_proto.getLoop = abvideo_getLoop;

/*****************************************************************
 *              Media player methods
 ****************************************************************/

/**
 *  Start the video
 *
 *  @name play
 *  @function
 *  @memberOf ABVideo.prototype
 */
function abvideo_play ()
{
  if (!this.__video_node) { return; }
  
  this.__video_node.streamStatus = "play";
  this.__is_playing = true;
};
abvideo_proto.play = abvideo_play;

/**
 *  Stop the video
 *
 *  @name stop
 *  @function
 *  @memberOf ABVideo.prototype
 */
function abvideo_stop ()
{
  if (!this.__video_node) { return; }
  
  this.__video_node.streamStatus = "stop";
  this.__is_playing = false;
};
abvideo_proto.stop = abvideo_stop;

/*****************************************************************
 *
 ****************************************************************/

/**
 *
 *  @name initSkin
 *  @function
 *  @memberOf ABVideo.prototype
 *
 * @private
 */
function abvideo_initSkin ()
{
  this.apply ('ABView', 'initSkin');

  if (this.view)
  {
    this.__video_node = this.view;
//     var child = this.view.firstChild;
//     while (child && __getTagName (child) != 'object' && 
//           __getTagName (child) != 'OBJECT')
//     { child = child.nextSibling; }
//     
//     if (!child)
//     {
//       printlnConsole ("ERROR ABVideo.initSkin");
//       return;
//     }
//     this.__video_node = child;
  }
};
abvideo_proto.initSkin = abvideo_initSkin;

var ABVideo = Class.create ('ABVideo', abvideo_proto);
Class.extend ('ABVideo', 'ABView');

/**
 * Error code
 * @const
 */
ABVideo.UNKNOWN_ERR = 0;

/**
 * Error code: The fetching process for the media resource was aborted by the 
 * user agent at the user's request.
 * @const
 */
ABVideo.MEDIA_ERR_ABORTED = 1;

/**
 * Error code: A network error of some description caused the user agent to 
 * stop fetching the media resource, after the resource was established to
 * be usable
 * @const
 */
ABVideo.MEDIA_ERR_NETWORK = 2;

/**
 * Error code: An error of some description occurred while decoding the
 * media resource, after the resource was established to be usable.
 * @const
 */
ABVideo.MEDIA_ERR_DECODE = 3;

/**
 * Error code: The media resource indicated by the src attribute was not 
 * suitable.
 * @const
 */
ABVideo.MEDIA_ERR_SRC_NOT_SUPPORTED = 4;/**
 Copyright (C) 2009-2011. ViniSketch SARL - David Thevenin

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

/**
 * @private
 */
var abnavbutton_proto = new Object ();

/**
 *  ABNavButton class. <br/>
 *  Default constructor of the ABNavButton.
 *  @example
 *  var config = new Object ();
 *  config.id = "buttonId";
 *  var myButton = Class["new"] ("ABNavButton", config);
 *  myButton.init ();
 *  myButton.setText ("Hello World!");
 *  myButton.setSrc ("file://...");
 *  myButton.setFocusSrc ("file://...");
 *  myButton.setActiveSrc ("file://...");
 *
 *  @extends ABView
 *  @class
 *  A navigation button implements a button for TV set. It intercepts pad
 *  event and sends a event when activated.
 *  <br /><br />
 *  A navigation view is a view that implements by default three states:
 *  default, focus and active, and mangage three different views (and CSS style) 
 *  for each states. According the user interaction, the view will switch
 *  between states and state's views.
 *  <br /><br />
 *  You can custom each state's button image and text using the appropriate
 *  method and css styling (text size, color, ...)
 *  <br />
 *  The id of each state view is: {comp.id}_[d/f/a]
 *  <br />
 *  The text of the focus and/or active state will be the same than default
 *  text if you do not define one.
 *  <br />
 *  If you do not define a image for active or focus state no image will be
 *  used by default.
 *
 *
 *  @name ABNavButton
 *  @constructor
 */
function abnavbutton_constructor (config)
{
  this.apply ('ABView', '_constructor', config);

  // init default image src with the attribute node img.src
  // if it exists. Use getAttribute instead of direct property
  // in order to have a relative path (without base)
  if (this._default_img_view)
  { this._src = this._default_img_view.data; }
  if (this._active_img_view)
  { this._active_src = this._active_img_view.data; }
  if (this._focus_img_view)
  { this._focus_src = this._focus_img_view.data; }
}
abnavbutton_proto._constructor = abnavbutton_constructor;

/**
 * The text value
 * @protected
 * @type {string}
 */
abnavbutton_proto._text = "";
abnavbutton_proto._src = null;

/**
 * The text when the width has focus
 * @protected
 * @type {string}
 */
abnavbutton_proto._focus_text = null;
abnavbutton_proto._focus_src = null;

/**
 * The text when the width is active
 * @protected
 * @type {string}
 */
abnavbutton_proto._active_text = null;
abnavbutton_proto._active_src = null;

/**
 * The default view
 * @protected
 * @type {HtmlPElement}
 */
abnavbutton_proto._default_text_view = null;
abnavbutton_proto._default_img_view = null;

/**
 * The focus view
 * @protected
 * @type {HtmlPElement}
 */
abnavbutton_proto._focus_text_view = null;
abnavbutton_proto._focus_img_view = null;

/**
 * The active view
 * @protected
 * @type {HtmlPElement}
 */
abnavbutton_proto._active_text_view = null;
abnavbutton_proto._active_img_view = null;

/*****************************************************************
 *
 ****************************************************************/
/** 
 *  Setter for size. Gives the dimensions of the visual content
 *
 *  @name setSize
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 *  @function.
 *  @param {Array.<number>} size the object size
 */ 
function abnavbutton_setSize (v)
{
  this.apply ('ABView', 'setSize', v);

  var border = 2 * __getBorderWidth (this._default_text_view);
  var width = this._size [0] - border - 
    __getPaddingRight (this._default_text_view) - 
    __getPaddingLeft (this._default_text_view);
  var height = this._size [1] - border - 
    __getPaddingTop (this._default_text_view) - 
    __getPaddingBottom (this._default_text_view);
  __setSize (this._default_text_view, width, height);
  
  border = 2 * __getBorderWidth (this._focus_text_view);
  width = this._size [0] - border - 
    __getPaddingRight (this._focus_text_view) - 
    __getPaddingLeft (this._focus_text_view);
  height = this._size [1] - border - 
    __getPaddingTop (this._focus_text_view) - 
    __getPaddingBottom (this._focus_text_view);

  __setSize (this._focus_text_view, width, height);

  border = 2 * __getBorderWidth (this._active_text_view);
  width = this._size [0] - border - 
    __getPaddingRight (this._active_text_view) - 
    __getPaddingLeft (this._active_text_view);
  height = this._size [1] - border - 
    __getPaddingTop (this._active_text_view) - 
    __getPaddingBottom (this._active_text_view);

  __setSize (this._active_text_view, width, height);
};
abnavbutton_proto.setSize = abnavbutton_setSize;

/*****************************************************************
 *
 ****************************************************************/
/**
 * Set the text value
 *
 *  @name setText
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @param {string} text The text value
 */
function abnavbutton_set_text (v)
{
  if (typeof (v) == "undefined") { v = ''; }
  else if (Object.isNumber (v)) { v = '' + v; }
  else if (!Object.isString (v))
  {
    if (!v.toString) { return; }
    v = v.toString ();
  }
  
  this._text = v;
  __setInnerText (this._default_text_view, this._text);
  if (!Object.isString (this._focus_text))
  {
    __setInnerText (this._focus_text_view, this._text);
  }
  if (!Object.isString (this._active_text))
  {
    __setInnerText (this._active_text_view, this._text);
  }
}
abnavbutton_proto.setText = abnavbutton_set_text;

/**
 *  Returns the text value
 *
 *  @name getText
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @return {string}
 */
function abnavbutton_get_text ()
{
  return this._text;
}
abnavbutton_proto.getText = abnavbutton_get_text;

/**
 *  The text when the widget has the focus
 *
 *  @name setFocusText
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @param {string} text The text value
 */
function abnavbutton_set_focus_text (v)
{
  if (typeof (v) == "undefined") { v = ''; }
  else if (Object.isNumber (v)) { v = '' + v; }
  else if (!Object.isString (v))
  {
    if (!v.toString) { return; }
    v = v.toString ();
  }
  
  this._focus_text = v;
  __setInnerText (this._focus_text_view, this._focus_text);
}
abnavbutton_proto.setFocusText = abnavbutton_set_focus_text;

/**
 *  Returns the text value
 *
 *  @name getFocusText
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @return {string}
 */
function abnavbutton_get_focus_text ()
{
  return this._focus_text;
}
abnavbutton_proto.getFocusText = abnavbutton_set_focus_text;

/**
 *  The text when the widget is active
 *
 *  @name setActiveText
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @param {string} text The text value
 */
function abnavbutton_set_active_text (v)
{
  if (typeof (v) == "undefined") { v = ''; }
  else if (Object.isNumber (v)) { v = '' + v; }
  else if (!Object.isString (v))
  {
    if (!v.toString) { return; }
    v = v.toString ();
  }
  
  this._active_text = v;
  __setInnerText (this._active_text_view, this._active_text);
}
abnavbutton_proto.setActiveText = abnavbutton_set_active_text;

/**
 *  Returns the text value
 *
 *  @name getActiveText
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @return {string}
 */
function abnavbutton_get_active_text ()
{
  return this._active_text;
}
abnavbutton_proto.getActiveText = abnavbutton_get_active_text;


/*****************************************************************
 *
 ****************************************************************/


/**
 *  Set the default image source url
 *
 *  @name setSrc
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @param {string} url image url path
 */
function abnavbutton_set_src (v)
{
  if (!Object.isString (v)) { return; }
  this._src = v;
  
  if (this._default_img_view)
  {
    this._default_img_view.data = this._src;
  }
}
abnavbutton_proto.setSrc = abnavbutton_set_src;

/**
 *  Returns the default image source url
 *
 *  @name getSrc
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @return {string} image url path
 */
function abnavbutton_get_src ()
{
  return this._src;
}
abnavbutton_proto.getSrc = abnavbutton_get_src;

/**
 *  Set the focus image source url
 *
 *  @name setFocusSrc
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @param {string} url image url path
 */
function abnavbutton_set_focus_src (v)
{
  if (!Object.isString (v)) { return; }
  this._focus_src = v;
  
  if (this._focus_img_view)
  {
    this._focus_img_view.data = this._focus_src;
  }
}
abnavbutton_proto.setFocusSrc = abnavbutton_set_focus_src;

/**
 *  Returns the focus image source url
 *
 *  @name getFocusSrc
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @return {string} image url path
 */
function abnavbutton_get_focus_src ()
{
  return this._focus_src;
}
abnavbutton_proto.getFocusSrc = abnavbutton_get_focus_src;

/**
 *  Set the active image source url
 *
 *  @name setActiveSrc
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @param {string} url image url path
 */
function abnavbutton_set_active_src (v)
{
  if (!Object.isString (v)) { return; }
  this._active_src = v;
  
  if (this._active_img_view)
  {
    this._active_img_view.data = this._active_src;
  }
}
abnavbutton_proto.setActiveSrc = abnavbutton_set_active_src;

/**
 *  Returns the active image source url
 *
 *  @name getActiveSrc
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 * @return {string} image url path
 */
function abnavbutton_get_active_src ()
{
  return this._active_src;
}
abnavbutton_proto.getActiveSrc = abnavbutton_get_active_src;

/*****************************************************************
 *
 ****************************************************************/

/**
 * @protected
 */
function abnavbutton_destructor ()
{
  if (this.view)
  {
    // force image free
    this._default_img_view.data = 
      'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
    this._focus_img_view.data = 
      'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
    this._active_img_view.data = 
      'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
    delete (this._default_img_view);
    delete (this._focus_img_view);
    delete (this._active_img_view);
  }

  this.apply ('ABView', 'destructor');
}
abnavbutton_proto.destructor = abnavbutton_destructor;

/*****************************************************************
 *
 ****************************************************************/  

/**
 * @private
 */
function abnavbutton__onFocus ()
{
  __setVisible (this._default_img_view, false);
  __setVisible (this._focus_img_view, true);
  __setVisible (this._active_img_view, false);
  __setVisible (this._default_text_view, false);
  __setVisible (this._focus_text_view, true);
  __setVisible (this._active_text_view, false);
  
  this.apply ('ABView', '_onFocus');
}
abnavbutton_proto._onFocus = abnavbutton__onFocus;

/**
 * @private
 */
function abnavbutton__onBlur ()
{
  __setVisible (this._default_img_view, true);
  __setVisible (this._focus_img_view, false);
  __setVisible (this._active_img_view, false);
  __setVisible (this._default_text_view, true);
  __setVisible (this._focus_text_view, false);
  __setVisible (this._active_text_view, false);
  
  this.apply ('ABView', '_onBlur');
}
abnavbutton_proto._onBlur = abnavbutton__onBlur;

/**
 * @private
 */
function abnavbutton__onBeforeActive ()
{
  __setVisible (this._default_img_view, false);
  __setVisible (this._focus_img_view, false);
  __setVisible (this._active_img_view, true);
  __setVisible (this._default_text_view, false);
  __setVisible (this._focus_text_view, false);
  __setVisible (this._active_text_view, true);
  
  this.apply ('ABView', '_onBeforeActive');
}
abnavbutton_proto._onBeforeActive = abnavbutton__onBeforeActive;

/**
 * @private
 */
function abnavbutton__onActive ()
{
  __setVisible (this._default_img_view, false);
  __setVisible (this._focus_img_view, true);
  __setVisible (this._active_img_view, false);
  __setVisible (this._default_text_view, false);
  __setVisible (this._focus_text_view, true);
  __setVisible (this._active_text_view, false);
  
  this.apply ('ABView', '_onActive');
  
  this.propagate ('select');
}
abnavbutton_proto._onActive = abnavbutton__onActive;

/*****************************************************************
 *
 ****************************************************************/

/**
 *
 *  @name _initStateView
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 *  @private
 */
function navbutton_initstateview (child, state)
{
  while (child && __getTagName (child) != 'object' && 
        __getTagName (child) != 'OBJECT')
  { child = child.nextSibling; }
  
  if (!child)
  {
    printlnConsole ("ERROR ABNavButton.initStateView 1");
    return;
  }
  if (!child)
  {
    printlnConsole ("ERROR ABNavButton.initStateView 1");
    return;
  }
  this['_' + state + '_img_view'] = child;

  child = child.nextSibling;
  while (child && __getTagName (child) != 'p' && 
        __getTagName (child) != 'P')
  { child = child.nextSibling; }
  if (!child)
  {
    printlnConsole ("ERROR ABNavButton.initStateView 2");
    return;
  }
  this['_' + state + '_text_view'] = child;
  child = child.nextSibling;
  return child;
}
abnavbutton_proto._initStateView = navbutton_initstateview;

/**
 *
 *  @name initSkin
 *  @function
 *  @memberOf ABNavButton.prototype
 *
 *  @protected
 */
function abnavbutton_initSkin ()
{
  this.apply ('ABView', 'initSkin');

  if (this.view)
  {
    var child = this.view.firstChild;
    child = this._initStateView (child, 'default');
    child = this._initStateView (child, 'focus');
    child = this._initStateView (child, 'active');

    __setVisible (this._default_img_view, true);
    __setVisible (this._focus_img_view, false);
    __setVisible (this._active_img_view, false);
    __setVisible (this._default_text_view, true);
    __setVisible (this._focus_text_view, false);
    __setVisible (this._active_text_view, false);

    __setPos (this._default_text_view, 0, 0);
    __setPos (this._default_img_view, 0, 0);
    __setPos (this._focus_text_view, 0, 0);
    __setPos (this._focus_img_view, 0, 0);
    __setPos (this._active_text_view, 0, 0);
    __setPos (this._active_img_view, 0, 0);

    this.setSize (__getSize (this.view));
  }
}
abnavbutton_proto.initSkin = abnavbutton_initSkin;

var ABNavButton = Class.create ('ABNavButton', abnavbutton_proto);
Class.extend ('ABNavButton', 'ABView');

/**
 Copyright (C) 2009-2011. ViniSketch SARL - David Thevenin

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

/**
 * @private
 */
var abnavsegmentedbutton_proto = new Object ();

/**
 *  ABNavSegmentedButton class. <br/>
 *  Default constructor of the ABNavSegmentedButton.
 *  @example
 *  var config = new Object ();
 *  config.id = "buttonId";
 *  var myButton = Class["new"] ("ABNavSegmentedButton", config);
 *  myButton.init ();
 *  var data = new Array ('item1', 'item2', 'item3');
 *  myButton.setData (data);
 *
 *  @extends ABView
 *  @class
 *  A navigation Segmented button is a horizontal control made of multiple
 *  buttons.
 *  <br />
 *  A segmented button can display for each segment a title and images.
 *  Images will change according the focus or activation event.
 *  <br /><br />
 *  The ABNavSegmentedButton segments automatically resize to fit
 *  proportionally within their superview.
 *  <br /><br />
 *  As any navigation view, each segment implements by default three states:
 *  default, focus and active, and mangage three different images and css 
 *  for each states. According the user interaction, the view will switch
 *  between states and state's views.
 *  <br /><br />
 *  You can custom the text color, background, ..., using css. The css name 
 *  class to custom is : <ul>
 *    <li />comp.id + '_t' => default style
 *    <li />comp.id + '_t':focus => fpcus style
 *    <li />comp.id + '_t':focus => active style
 *  </ul>
 *  <br />
 *  For now the API does not allow to change the segments images.
 *
 *  @name ABNavSegmentedButton
 *  @constructor
 */
var __nsb_current_object = null;

function abnavsegmentedbutton_constructor (config)
{
  this.apply ('ABView', '_constructor', config);

  this._buttons = new Array ();
  this._images = new Array ();
  this._texts = new Array ();
}
abnavsegmentedbutton_proto._constructor = abnavsegmentedbutton_constructor;

/**
 * The text value
 * @protected
 * @type {string}
 */
abnavsegmentedbutton_proto._data = null;

abnavsegmentedbutton_proto._focused_item = 0;

/*****************************************************************
 *
 ****************************************************************/
/** 
 *  Setter for size. Gives the dimensions of the visual content
 *
 *  @name setSize
 *  @function
 *  @memberOf ABNavSegmentedButton.prototype
 *
 *  @function.
 *  @type {Array.<number>}
 */ 
function abnavsegmentedbutton_setSize (v)
{
  this.apply ('ABView', 'setSize', v);
  var posX = 0;

  var nb = this._texts.length;

  if (nb)
  {
    var width = this._size [0] / nb; // division entiere uniquement
    var height = this._size [1];
    
    var p = this._texts [0];
    var border = 2 * __getBorderWidth (p);
    var padding = __getPaddingTop (p) + __getPaddingBottom (p);
    
    for (var i = 0; i < nb; i++)
    {
      var div = this._buttons [i];
      p = this._texts [i];
      __setSize (div, width, height);
      __setSize (p, width - border, height - border - padding);
      __setPos (div, posX, 0);
      posX += width;
    }
  }
};
abnavsegmentedbutton_proto.setSize = abnavsegmentedbutton_setSize;

/** 
 *
 *  @name _onFocusNext
 *  @function
 *  @memberOf ABNavSegmentedButton.prototype
 *
 *  @function.
 *  @private
 */ 
function abnavsegmentedbutton__focus_next ()
{
  if (this._focused_item >= this._texts.length - 1)
  { return false; }
  
  this._focused_item ++;
  this._onFocus ();
  return true;
};
abnavsegmentedbutton_proto._onFocusNext = abnavsegmentedbutton__focus_next;

/** 
 *
 *  @name _onFocusPred
 *  @function
 *  @memberOf ABNavSegmentedButton.prototype
 *
 *  @function.
 *  @private
 */ 
function abnavsegmentedbutton__focus_pred ()
{
  if (this._focused_item <= 0)
  { return false; }
  
  this._focused_item --;
  this._onFocus ();
  return true;
};
abnavsegmentedbutton_proto._onFocusPred = abnavsegmentedbutton__focus_pred;


var __nsb_to_blur = false;

/**
 * @private
 */
function __nsb_keydown (event)
{
  if (!event) 
  { event = document.currentEvent; }
  
  var didPropagate = false;

  if (__nsb_current_object)
  {
    if (event.keyCode == KEYBOARD.ENTER) return;
    
    if (event.keyCode == KEYBOARD.RIGHT_ARROW)
    {
      didPropagate = __nsb_current_object._onFocusNext ();
    }
    else if (event.keyCode == KEYBOARD.LEFT_ARROW)
    {
      didPropagate = __nsb_current_object._onFocusPred ();
    }
  }

  if (!didPropagate)
  {
    var myEvent = new Object ();
    myEvent.type = event.keyCode;
    myEvent.data = event;
    for (key in Application_applications)
    {
      obj = Application_applications [key];
      if (obj._hasNavigation (myEvent))
      {
        __nsb_current_object = null;
        __init_keyboard_handler ();
        obj.keyboardListener (myEvent) ;
        return;
      }
    }
  }
}

/*****************************************************************
 *
 ****************************************************************/
/**
 *  Set the titles.
 *  <br/>
 *  Because of BML limitations, it is not possible to add new node into
 *  the view. Then you can not add new tile, you can only change the tile's
 *  name.
 *
 *  @name setData
 *  @function
 *  @memberOf ABNavSegmentedButton.prototype
 *
 *  @example
 *  var data = new Array ('item1', 'item2', 'item3');
 *  myButton.setData (data);
 *
 * * @param {Array<string>} titles The array of title texts
 */
function abnavsegmentedbutton_set_data (v)
{
  if (typeof (v) == "undefined") { v = new Array (); }
  else if (!Object.isArray (v)) { return; }

  var nb = this._texts.length;
  for (var i = 0; i < nb; i++)
  {
    var p = this._texts [i];
    var text = v [i];
    __setInnerText (p, text);
  }

  this._data = v;
  this._focused_item = 0;
  this.setSize (__getSize (this.view));
}
abnavsegmentedbutton_proto.setData = abnavsegmentedbutton_set_data;

/********************************************************************
                
********************************************************************/
/**
 *
 *  @name _onFocus
 *  @function
 *  @memberOf ABNavSegmentedButton.prototype
 *
 * @protected
 */
function abnavsegmentedbutton__onFocus ()
{
  this.apply ('ABView', '_onFocus');
  
  var p = this._texts [this._focused_item];
  if (p) p.focus ();
  __nsb_current_object = this;
};
abnavsegmentedbutton_proto._onFocus = abnavsegmentedbutton__onFocus;

/**
 *
 *  @name _onBlur
 *  @function
 *  @memberOf ABNavSegmentedButton.prototype
 *
 * @protected
 */
function abnavsegmentedbutton__onBlur ()
{
  this.apply ('ABView', '_onBlur');
  
  var p = this._texts [this._focused_item];
  if (p) p.blur ();
  __nsb_current_object = null;
};
abnavsegmentedbutton_proto._onFocus = abnavsegmentedbutton__onFocus;

/*****************************************************************
 *
 ****************************************************************/

/**
 * @protected
 */
function abnavsegmentedbutton_destructor ()
{
  if (this.view)
  {

  }

  this.apply ('ABView', 'destructor');
}
abnavsegmentedbutton_proto.destructor = abnavsegmentedbutton_destructor;

/*****************************************************************
 *
 ****************************************************************/

/**
 *
 *  @name _initStateView
 *  @function
 *  @memberOf ABNavSegmentedButton.prototype
 *
 *  @private
 */
function abnavsegmentedbutton_init_button (child, i)
{
  while (child && __getTagName (child) != 'div' && 
        __getTagName (child) != 'DIV')
  { child = child.nextSibling; }
  
  if (!child)
  {
    printlnConsole ("ERROR ABNavSegmentedButton.initButton 1");
    return;
  }
  var div = child;
  this._buttons[i] = div;
 
  var childchild = div.firstChild;
  
  while (childchild && __getTagName (childchild) != 'object' && 
        __getTagName (childchild) != 'OBJECT')
  { childchild = childchild.nextSibling; }
  
  if (!childchild)
  {
    printlnConsole ("ERROR ABNavSegmentedButton.initStateView 1");
    return;
  }
  this._images [i] = childchild;

  childchild = childchild.nextSibling;
  while (childchild && __getTagName (childchild) != 'p' && 
        __getTagName (childchild) != 'P')
  { childchild = childchild.nextSibling; }
  if (!childchild)
  {
    printlnConsole ("ERROR ABNavSegmentedButton.initStateView 2");
    return;
  }
  this._texts [i] = childchild;
 
  child = child.nextSibling;
  return child;
}
abnavsegmentedbutton_proto._initButton = abnavsegmentedbutton_init_button;

/**
 *
 *  @name initSkin
 *  @function
 *  @memberOf ABNavSegmentedButton.prototype
 *
 *  @protected
 */
function abnavsegmentedbutton_initSkin ()
{
  this.apply ('ABView', 'initSkin');
  
  if (this.view)
  {
    var child = this.view.firstChild;
    var index = 0;
    while (child)
    {
      child = this._initButton (child, index);
      index++;
    }
    
    this.setSize (__getSize (this.view));
  }
}
abnavsegmentedbutton_proto.initSkin = abnavsegmentedbutton_initSkin;

var ABNavSegmentedButton = Class.create ('ABNavSegmentedButton', abnavsegmentedbutton_proto);
Class.extend ('ABNavSegmentedButton', 'ABView');

/**
 Copyright (C) 2009-2011. ViniSketch SARL - David Thevenin

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

/**
 * @private
 */
var abswitch_proto = new Object ();

/**
 *  ABSwitch class. <br/>
 *  Default constructor of the ABSwitch.
 *  @example
 *  var toggle = new ABSwitch (config);
 *  toggle.init ();
 *
 *  toggle.setTextOn ('I');
 *  toggle.setTextOff ('O');
 *
 *  @extends ABView
 *  @class
 *  The ABSwitch display an element showing the boolean state value.
 *  User is able to tap the control to change the value.
 *  <p>
 *  Events:
 *  <ul>
 *    <li /> change: Fired after the switch is tap. Event.data = true if button is toggled.
 *  </ul>
 *  <p>
 * <p>
 *
 *  @author David Thevenin
 *
 *  @name ABSwitch
 *  @constructor
 *   Creates a new ABSwitch.
 *
 *	@param {Object} config the configuration stucture [mandatory]
*/
function abswitch_constructor (config)
{
  this.apply ('ABView', '_constructor', config);
}
abswitch_proto._constructor = abswitch_constructor;

/**
 * The text value
 * @protected
 * @type {string}
 */
abswitch_proto._text_on = "On";

/**
 * The text when the width has focus
 * @protected
 * @type {string}
 */
abswitch_proto._text_off = "Off";

/**
 * The text when the width has focus
 * @protected
 * @type {string}
 */
abswitch_proto._toggle = true;

/*****************************************************************
 *
 ****************************************************************/
/** 
 *  Setter for size. Gives the dimensions of the visual content
 *
 *  @name setSize
 *  @function
 *  @memberOf ABSwitch.prototype
 *
 *  @function.
 *  @param {Array.<number>} size the object size
 */ 
function abswitch_setSize (v)
{
  this.apply ('ABView', 'setSize', v);
  
  var width = this._size [0] -
    __getPaddingRight (this._on_view) - 
    __getPaddingLeft (this._on_view) - 20;
  var height = this._size [1] - 
    __getPaddingTop (this._on_view) - 
    __getPaddingBottom (this._on_view);
  __setSize (this._on_view, width, height);
  __setPos (this._on_view, 0, 0);
  
  width = this._size [0] -
    __getPaddingRight (this._off_view) - 
    __getPaddingLeft (this._off_view) - 20;
  height = this._size [1] - 
    __getPaddingTop (this._off_view) - 
    __getPaddingBottom (this._off_view);
  __setSize (this._off_view, width, height);
  __setPos (this._off_view, 20, 0);
};
abswitch_proto.setSize = abswitch_setSize;

/*****************************************************************
 *
 ****************************************************************/
 /**
 * Set the text value
 *
 *  @name setToggle
 *  @function
 *  @memberOf ABSwitch.prototype
 *
 * @param {boolean} value Set the toggled state.
 */
function abswitch_set_toggle (v)
{
  if (v)
  {
    this._toggle = true;
    __setVisible (this._on_view, true);
    __setVisible (this._off_view, false);
  }
  else
  {
    this._toggle = false;
    __setVisible (this._on_view, false);
    __setVisible (this._off_view, true);
  }
}
abswitch_proto.setToggle = abswitch_set_toggle;

/**
 *  Returns the toggled state.
 *
 *  @name getToggle
 *  @function
 *  @memberOf ABSwitch.prototype
 *
 * @return {boolean}
 */
function abswitch_get_toggle ()
{
  return this._toggle;
}
abswitch_proto.getToggle = abswitch_get_toggle;


/**
 *  Set the text value for the switch when its on
 *
 *  @name setTextOn
 *  @function
 *  @memberOf ABSwitch.prototype
 *
 * @param {string} text The text value
 */
function abswitch_set_text_on (v)
{
  if (typeof (v) == "undefined") { v = ''; }
  else if (Object.isNumber (v)) { v = '' + v; }
  else if (!Object.isString (v))
  {
    if (!v.toString) { return; }
    v = v.toString ();
  }
  
  this._text_on = v;
  __setInnerText (this._on_view, this._text_on);
}
abswitch_proto.setTextOn = abswitch_set_text_on;

/**
 *  Returns the text value for the switch when its on
 *
 *  @name getTextOn
 *  @function
 *  @memberOf ABSwitch.prototype
 *
 * @return {string}
 */
function abswitch_get_text_on ()
{
  return this._text_on;
}
abswitch_proto.getTextOn = abswitch_get_text_on;


/**
 *  Set the text value for the switch when its off.
 *
 *  @name setTextOff
 *  @function
 *  @memberOf ABSwitch.prototype
 *
 * @param {string} text The text value
 */
function abswitch_set_text_off (v)
{
  if (typeof (v) == "undefined") { v = ''; }
  else if (Object.isNumber (v)) { v = '' + v; }
  else if (!Object.isString (v))
  {
    if (!v.toString) { return; }
    v = v.toString ();
  }
  
  this._text_off = v;
  __setInnerText (this._off_view, this._text_off);
}
abswitch_proto.setTextOff = abswitch_set_text_off;

/**
 *  Returns the text value for the switch when its off
 *
 *  @name getTextOff
 *  @function
 *  @memberOf ABSwitch.prototype
 *
 * @return {string}
 */
function abswitch_get_text_off ()
{
  return this._text_off;
}
abswitch_proto.getTextOff = abswitch_get_text_off;

/*****************************************************************
 *
 ****************************************************************/

/**
 * @private
 */
function abswitch__onFocus ()
{
  this.view.normalStyle.borderBottomColorIndex = 7;
  this.apply ('ABView', '_onFocus');
}
abswitch_proto._onFocus = abswitch__onFocus;

/**
 * @private
 */
function abswitch__onBlur ()
{
  this.view.normalStyle.borderBottomColorIndex = 15;
  this.apply ('ABView', '_onBlur');
}
abswitch_proto._onBlur = abswitch__onBlur;

/**
 * @private
 */
function abswitch__onBeforeActive ()
{
  this.setToggle (!this._toggle);
  this.apply ('ABView', '_onBeforeActive');
}
abswitch_proto._onBeforeActive = abswitch__onBeforeActive;

/**
 * @private
 */
function abswitch__onActive ()
{
  this.apply ('ABView', '_onBeforeActive');
  this.propagate ('change', this._toggle);
}
abswitch_proto._onActive = abswitch__onActive;


/*****************************************************************
 *
 ****************************************************************/

/**
 *
 *  @name initSkin
 *  @function
 *  @memberOf ABSwitch.prototype
 *
 *  @protected
 */
function abswitch_initSkin ()
{
  this.apply ('ABView', 'initSkin');

  if (this.view)
  {
    var child = this.view.firstChild;
    while (child && __getTagName (child) != 'p' && 
          __getTagName (child) != 'P')
    { child = child.nextSibling; }
    if (!child)
    {
      printlnConsole ("ERROR ABSwitch.initStateView 1");
      return;
    }
    this._on_view = child;
    child = child.nextSibling;

    while (child && __getTagName (child) != 'p' && 
          __getTagName (child) != 'P')
    { child = child.nextSibling; }
    if (!child)
    {
      printlnConsole ("ERROR ABSwitch.initStateView 2");
      return;
    }
    this._off_view = child;

    this.setSize (__getSize (this.view));
    this.setToggle (this._toggle);
  }
}
abswitch_proto.initSkin = abswitch_initSkin;

var ABSwitch = Class.create ('ABSwitch', abswitch_proto);
Class.extend ('ABSwitch', 'ABView');

/**
 Copyright (C) 2009-2011. ViniSketch SARL - David Thevenin

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

/**
 * @private
 */
var abradiobutton_proto = new Object ();

/**
 *  ABRadioButton class. <br/>
 *  Default constructor of the ABRadioButton.
 *  @example
 *  var config = new Object ();
 *  config.id = "buttonId";
 *  var myButtons = Class["new"] ("ABRadioButton", config);
 *  myButtons.init ();
 *  var data = new Array ('item1', 'item2', 'item3');
 *  myButtons.setData (data);
 *  myButtons.setSelectedIndex (2);
 *
 *  @extends ABView
 *  @class
 *  The ABRadioButton class creates a vertical radio button list which allow
 *  to select one - and just one - option from a set of alternatives.
 *  <p>
 *  If more options are to be allowed at the same time you should use 
 *  ABCheckBox instead
 *  <p>
 *  Events:
 *  <ul>
 *    <li />change, fired when a item is selected.
 *          Event Data = {index, item}
 *  <ul>
 *  <p>
 *
 *  @name ABRadioButton
 *  @constructor
 */
var __nrb_current_object = null;

function abradiobutton_constructor (config)
{
  this.apply ('ABView', '_constructor', config);

  this._buttons = new Array ();
  this._images = new Array ();
  this._texts = new Array ();
  this._checks = new Array ();
}
abradiobutton_proto._constructor = abradiobutton_constructor;

/**
 * The text value
 * @protected
 * @type {string}
 */
abradiobutton_proto._data = null;

/**
 * @private
 * @type {int}
 */
abradiobutton_proto._selected_index = -1;

/**
 * @private
 * @type {int}
 */
abradiobutton_proto._focused_item = 0;

/*****************************************************************
 *
 ****************************************************************/
/** 
 *  Setter for size. Gives the dimensions of the visual content
 *
 *  @name setSize
 *  @function
 *  @memberOf ABRadioButton.prototype
 *
 *  @function.
 *  @type {Array.<number>}
 */ 
function abradiobutton_setSize (v)
{
  this.apply ('ABView', 'setSize', v);
  var posY = 0;

  var nb = this._texts.length;

  if (nb)
  {
    var width = this._size [0];
    var height = this._size [1] / nb; // division entiere uniquement
    var top = (height - 24) / 2;
    
    var p = this._texts [0], check;
    var border = 2 * __getBorderWidth (p);
    var padding = __getPaddingTop (p) + __getPaddingBottom (p);
    
    for (var i = 0; i < nb; i++)
    {
      var div = this._buttons [i];
      p = this._texts [i];
      check = this._checks [i];
      __setSize (div, width, height);
      __setSize (p, width - border, height - border - padding);
      __setPos (div, 0, posY);
      __setPos (check, width - 30, top);
      posY += height;
    }
  }
};
abradiobutton_proto.setSize = abradiobutton_setSize;


/** 
 * Selects an item in the radio button.
 *
 *  @name setSelectedIndex
 *  @function
 *  @memberOf ABRadioButton.prototype
 *
 *  @param {int} index the item index to select
 */ 
function abradiobutton_set_selectedIndex (v)
{
  if (!Object.isNumber (v))
  {
    return;
  }
  
  if (v < 0 || v > this._buttons.length - 1) { return; }
  if (this._selected_index  == v) { return; }
  
  if (this._selected_index >= 0)
  {
    var check = this._checks [this._selected_index];
    if (check)
    {
      check.normalStyle.backgroundColorIndex = 8;
    }
  }
 
  if (this._buttons [v])
  {
    var check = this._checks [v];
    if (check)
    {
      check.normalStyle.backgroundColorIndex = 7;
      this._selected_index = v;
    }
  }
};
abradiobutton_proto.setSelectedIndex = abradiobutton_set_selectedIndex;

/** 
 *  Returns the selected item index
 *
 *  @name getSelectedIndex
 *  @function
 *  @memberOf ABRadioButton.prototype
 *
 *  @return {int} the index
 */ 
function abradiobutton_get_selectedIndex ()
{
  return this._selected_index;
};
abradiobutton_proto.getSelectedIndex = abradiobutton_get_selectedIndex;

/** 
 *
 *  @name _onFocusNext
 *  @function
 *  @memberOf ABRadioButton.prototype
 *
 *  @function
 *  @private
 */ 
function abradiobutton__focus_next ()
{
  if (this._focused_item >= this._texts.length - 1)
  { return false; }
  
  this._focused_item ++;
  this._onFocus ();
  return true;
};
abradiobutton_proto._onFocusNext = abradiobutton__focus_next;

/** 
 *
 *  @name _onFocusPred
 *  @function
 *  @memberOf ABRadioButton.prototype
 *
 *  @function
 *  @private
 */ 
function abradiobutton__focus_pred ()
{
  if (this._focused_item <= 0)
  { return false; }
  
  this._focused_item --;
  this._onFocus ();
  return true;
};
abradiobutton_proto._onFocusPred = abradiobutton__focus_pred;

/** 
 *
 *  @name _onBeforeActive
 *  @function
 *  @memberOf ABRadioButton.prototype
 *
 *  @function
 *  @private
 */ 
function abradiobutton__onBeforeActive ()
{
  this.apply ('ABView', '_onBeforeActive');
  
  this.setSelectedIndex (this._focused_item);
  
  var event = new Object ();
  event.index = this._selected_index;
  event.item = __getInnerText (this._texts [this._selected_index]);
  
  this.propagate ('change', event);
}
abradiobutton_proto._onBeforeActive = abradiobutton__onBeforeActive;

/**
 * @private
 */
function __nrb_keydown (event)
{
  if (!event) 
  { event = document.currentEvent; }
  
  var didPropagated = false;

  if (__nrb_current_object)
  {
    if (event.keyCode == KEYBOARD.ENTER)
    {
      __nrb_current_object._onBeforeActive ();
    }
    
    if (event.keyCode == KEYBOARD.DOWN_ARROW)
    {
      didPropagated = __nrb_current_object._onFocusNext ();
    }
    else if (event.keyCode == KEYBOARD.UP_ARROW)
    {
      didPropagated = __nrb_current_object._onFocusPred ();
    }
  }

  if (!didPropagated)
  {
    var myEvent = new Object ();
    myEvent.type = event.keyCode;
    myEvent.data = event;
    for (key in Application_applications)
    {
      obj = Application_applications [key];
      if (obj._hasNavigation (myEvent))
      {
        __nrb_current_object = null;
        __init_keyboard_handler ();
        obj.keyboardListener (myEvent);
        return;
      }
    }
  }
}

/*****************************************************************
 *
 ****************************************************************/
/**
 *  Set the titles of radio button items
 *  <br/>
 *  Because of BML limitations, it is not possible to add new node into
 *  the view. Then you can not add new title, you can only change the title's
 *  name.
 *
 *  @name setData
 *  @function
 *  @memberOf ABRadioButton.prototype
 *
 *  @example
 *  var data = new Array ('item1', 'item2', 'item3');
 *  myButton.setData (data);
 *
 *  @param {Array<string>} titles The array of title texts
 */
function abradiobutton_set_data (v)
{
  if (typeof (v) == "undefined") { v = new Array (); }
  else if (!Object.isArray (v)) { return; }

  var nb = this._texts.length;
  for (var i = 0; i < nb; i++)
  {
    var p = this._texts [i];
    var text = v [i];
    __setInnerText (p, text);
  }

  this._data = v;
  this._focused_item = 0;
  this.setSize (__getSize (this.view));
}
abradiobutton_proto.setData = abradiobutton_set_data;

/********************************************************************
                
********************************************************************/
/**
 *
 *  @name _onFocus
 *  @function
 *  @memberOf ABRadioButton.prototype
 *
 * @protected
 */
function abradiobutton__onFocus ()
{
  this.apply ('ABView', '_onFocus');
  
  var p = this._texts [this._focused_item];
  if (p) p.focus ();
  __nrb_current_object = this;
};
abradiobutton_proto._onFocus = abradiobutton__onFocus;

/**
 *
 *  @name _onBlur
 *  @function
 *  @memberOf ABRadioButton.prototype
 *
 * @protected
 */
function abradiobutton__onBlur ()
{
  this.apply ('ABView', '_onBlur');
  
  var p = this._texts [this._focused_item];
  if (p) p.blur ();
  __nrb_current_object = null;
};
abradiobutton_proto._onFocus = abradiobutton__onFocus;

/*****************************************************************
 *
 ****************************************************************/

/**
 * @protected
 */
function abradiobutton_destructor ()
{
  if (this.view)
  {

  }

  this.apply ('ABView', 'destructor');
}
abradiobutton_proto.destructor = abradiobutton_destructor;

/*****************************************************************
 *
 ****************************************************************/

/**
 *
 *  @name _initStateView
 *  @function
 *  @memberOf ABRadioButton.prototype
 *
 *  @private
 */
function abradiobutton_init_button (child, i)
{
  while (child && __getTagName (child) != 'div' && 
        __getTagName (child) != 'DIV')
  { child = child.nextSibling; }
  
  if (!child)
  {
    printlnConsole ("ERROR ABRadioButton.initButton 1");
    return;
  }
  var div = child;
  this._buttons[i] = div;
 
  var childchild = div.firstChild;
  
  while (childchild && __getTagName (childchild) != 'object' && 
        __getTagName (childchild) != 'OBJECT')
  { childchild = childchild.nextSibling; }
  
  if (!childchild)
  {
    printlnConsole ("ERROR ABRadioButton.initStateView 1");
    return;
  }
  this._images [i] = childchild;

  childchild = childchild.nextSibling;
  while (childchild && __getTagName (childchild) != 'p' && 
        __getTagName (childchild) != 'P')
  { childchild = childchild.nextSibling; }
  if (!childchild)
  {
    printlnConsole ("ERROR ABRadioButton.initStateView 2");
    return;
  }
  this._texts [i] = childchild;
 
  childchild = childchild.nextSibling;
  while (childchild && __getTagName (childchild) != 'div' && 
        __getTagName (childchild) != 'DIV')
  { childchild = childchild.nextSibling; }
  if (!childchild)
  {
    printlnConsole ("ERROR ABRadioButton.initStateView 3");
    return;
  }
  this._checks [i] = childchild;;
  
  child = child.nextSibling;
  return child;
}
abradiobutton_proto._initButton = abradiobutton_init_button;

/**
 *
 *  @name initSkin
 *  @function
 *  @memberOf ABRadioButton.prototype
 *
 *  @protected
 */
function abradiobutton_initSkin ()
{
  this.apply ('ABView', 'initSkin');
  
  if (this.view)
  {
    var child = this.view.firstChild;
    var index = 0;
    while (child)
    {
      child = this._initButton (child, index);
      index++;
    }
    
    this.setSize (__getSize (this.view));
  }
}
abradiobutton_proto.initSkin = abradiobutton_initSkin;

var ABRadioButton = Class.create ('ABRadioButton', abradiobutton_proto);
Class.extend ('ABRadioButton', 'ABView');

/**
 Copyright (C) 2009-2011. ViniSketch SARL - David Thevenin

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

/**
 * @private
 */
var abcheckbutton_proto = new Object ();

/**
 *  ABCheckButton class. <br/>
 *  Default constructor of the ABCheckButton.
 *  @example
 *  var config = new Object ();
 *  config.id = "buttonId";
 *  var myButtons = Class["new"] ("ABCheckButton", config);
 *  myButtons.init ();
 *  var data = new Array ('item1', 'item2', 'item3');
 *  myButtons.setData (data);
 *  var indexes = new Array (0, 2);
 *  myButtons.setSelectedIndexes (indexes);
 *
 *  @extends ABView
 *  @class
 *  The ABCheckButton class creates a vertical checkbox list which allows to 
 *  select one or more options from a set of alternatives.
 *  <p>
 *  If only one option is to be selected at a time you should use ABRadioButton
 *  instead.
 *  <p>
 *  Events:
 *  <ul>
 *    <li />change, fired when a item is selected.
 *          Event Data = index
 *  <ul>
 *  <p>
 *
 *  @name ABCheckButton
 *  @constructor
 */
var __ncb_current_object = null;

function abcheckbutton_constructor (config)
{
  this.apply ('ABView', '_constructor', config);

  this._buttons = new Array ();
  this._images = new Array ();
  this._texts = new Array ();
  this._checks = new Array ();
  this._selected_indexes = new Array ();
}
abcheckbutton_proto._constructor = abcheckbutton_constructor;

/**
 * The text value
 * @protected
 * @type {string}
 */
abcheckbutton_proto._data = null;

/**
 * @private
 * @type {int}
 */
abcheckbutton_proto._selected_indexes = null;

/**
 * @private
 * @type {int}
 */
abcheckbutton_proto._focused_item = 0;

/*****************************************************************
 *
 ****************************************************************/
/** 
 *  Setter for size. Gives the dimensions of the visual content
 *
 *  @name setSize
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 *  @function.
 *  @type {Array.<number>}
 */ 
function abcheckbutton_setSize (v)
{
  this.apply ('ABView', 'setSize', v);
  var posY = 0;

  var nb = this._texts.length;

  if (nb)
  {
    var width = this._size [0];
    var height = this._size [1] / nb; // division entiere uniquement
    var top = (height - 24) / 2;
    
    var p = this._texts [0], check;
    var border = 2 * __getBorderWidth (p);
    var padding = __getPaddingTop (p) + __getPaddingBottom (p);
    
    for (var i = 0; i < nb; i++)
    {
      var div = this._buttons [i];
      p = this._texts [i];
      check = this._checks [i];
      __setSize (div, width, height);
      __setSize (p, width - border, height - border - padding);
      __setPos (div, 0, posY);
      __setPos (check, width - 30, top);
      posY += height;
    }
  }
};
abcheckbutton_proto.setSize = abcheckbutton_setSize;

/** 
 *  Allows to select/unselect one item
 *
 *  @name changeAtIndex
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 *  @param {int} index the item's index to select/unselect
 */ 
function abcheckbutton_changeAtIndex (index)
{
  if (!Object.isNumber (index)) { return; }
  
  var i, check;
  
  // test the selected indexes and unselect the item
  // if it presents in the array
  for (i = 0; i < this._selected_indexes.length; i ++)
  {
    if (index == this._selected_indexes [i])
    {
      check = this._checks [index];
      if (check)
      {
        check.normalStyle.backgroundColorIndex = 8;
      }
      this._selected_indexes.remove (i);
      return;
    }
  }
  
  // The index is not selected, have to select the item
  check = this._checks [index];
  if (check)
  {
    check.normalStyle.backgroundColorIndex = 7;
  }
  this._selected_indexes [this._selected_indexes.length] = index;
};
abcheckbutton_proto.changeAtIndex = abcheckbutton_changeAtIndex;

/** 
 *  Allows to select one or more items
 *
 *  @name setSelectedIndexes
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 *  @param {Array.<int>} indexes the item's indexes to select
 */ 
function abcheckbutton_set_selectedIndexes (v)
{
  if (!Object.isArray (v)) { return; }
  
  var i, check;
  
  // unselect all items
  for (i = 0; i < this._checks.length; i ++)
  {
    check = this._checks [i];
    if (check)
    {
      check.normalStyle.backgroundColorIndex = 8;
    }
  }

  this._selected_indexes = v.slice ();
  
  for (i = 0; i < this._selected_indexes.length; i ++)
  {
    check = this._checks [this._selected_indexes[i]];
    if (check)
    {
      check.normalStyle.backgroundColorIndex = 8;
    }
  }
};
abcheckbutton_proto.setSelectedIndexes = abcheckbutton_set_selectedIndexes;

/** 
 *  Returns the selected item's indexes
 *
 *  @name getSelectedIndexes
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 *  @return {int} the index
 */ 
function abcheckbutton_get_selectedIndexes ()
{
  return this._selected_indexes.slice ();;
};
abcheckbutton_proto.getSelectedIndexes = abcheckbutton_get_selectedIndexes;

/** 
 *
 *  @name _onFocusNext
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 *  @function
 *  @private
 */ 
function abcheckbutton__focus_next ()
{
  if (this._focused_item >= this._texts.length - 1)
  { return false; }
  
  this._focused_item ++;
  this._onFocus ();
  return true;
};
abcheckbutton_proto._onFocusNext = abcheckbutton__focus_next;

/** 
 *
 *  @name _onFocusPred
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 *  @function
 *  @private
 */ 
function abcheckbutton__focus_pred ()
{
  if (this._focused_item <= 0)
  { return false; }
  
  this._focused_item --;
  this._onFocus ();
  return true;
};
abcheckbutton_proto._onFocusPred = abcheckbutton__focus_pred;

/** 
 *
 *  @name _onBeforeActive
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 *  @function
 *  @private
 */ 
function abcheckbutton__onBeforeActive ()
{
  this.apply ('ABView', '_onBeforeActive');
  
  this.changeAtIndex (this._focused_item);
  
  var event = new Object ();
  event.index = this._focused_item;
//  event.item = __getInnerText (this._texts [this._selected_index]);
  
  this.propagate ('change', event);
}
abcheckbutton_proto._onBeforeActive = abcheckbutton__onBeforeActive;

/**
 * @private
 */
function __ncb_keydown (event)
{
  if (!event) 
  { event = document.currentEvent; }
  
  var didPropagated = false;

  if (__ncb_current_object)
  {
    if (event.keyCode == KEYBOARD.ENTER)
    {
      __ncb_current_object._onBeforeActive ();
    }
    
    if (event.keyCode == KEYBOARD.DOWN_ARROW)
    {
      didPropagated = __ncb_current_object._onFocusNext ();
    }
    else if (event.keyCode == KEYBOARD.UP_ARROW)
    {
      didPropagated = __ncb_current_object._onFocusPred ();
    }
  }

  if (!didPropagated)
  {
    var myEvent = new Object ();
    myEvent.type = event.keyCode;
    myEvent.data = event;
    for (key in Application_applications)
    {
      obj = Application_applications [key];
      if (obj._hasNavigation (myEvent))
      {
        __ncb_current_object = null;
        __init_keyboard_handler ();
        obj.keyboardListener (myEvent);
        return;
      }
    }
  }
}

/*****************************************************************
 *
 ****************************************************************/
/**
 *  Set the titles of radio button items
 *  <br/>
 *  Because of BML limitations, it is not possible to add new node into
 *  the view. Then you can not add new title, you can only change the title's
 *  name.
 *
 *  @name setData
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 *  @example
 *  var data = new Array ('item1', 'item2', 'item3');
 *  myButton.setData (data);
 *
 *  @param {Array<string>} titles The array of title texts
 */
function abcheckbutton_set_data (v)
{
  if (typeof (v) == "undefined") { v = new Array (); }
  else if (!Object.isArray (v)) { return; }

  var nb = this._texts.length;
  for (var i = 0; i < nb; i++)
  {
    var p = this._texts [i];
    var text = v [i];
    __setInnerText (p, text);
  }

  this._data = v;
  this._focused_item = 0;
  this.setSize (__getSize (this.view));
}
abcheckbutton_proto.setData = abcheckbutton_set_data;

/********************************************************************
                
********************************************************************/
/**
 *
 *  @name _onFocus
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 * @protected
 */
function abcheckbutton__onFocus ()
{
  this.apply ('ABView', '_onFocus');
  
  var p = this._texts [this._focused_item];
  if (p) p.focus ();
  __ncb_current_object = this;
};
abcheckbutton_proto._onFocus = abcheckbutton__onFocus;

/**
 *
 *  @name _onBlur
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 * @protected
 */
function abcheckbutton__onBlur ()
{
  this.apply ('ABView', '_onBlur');
  
  var p = this._texts [this._focused_item];
  if (p) p.blur ();
  __ncb_current_object = null;
};
abcheckbutton_proto._onFocus = abcheckbutton__onFocus;

/*****************************************************************
 *
 ****************************************************************/

/**
 *
 *  @name _initStateView
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 *  @private
 */
function abcheckbutton_init_button (child, i)
{
  while (child && __getTagName (child) != 'div' && 
        __getTagName (child) != 'DIV')
  { child = child.nextSibling; }
  
  if (!child)
  {
    printlnConsole ("ERROR ABCheckButton.initButton 1");
    return;
  }
  var div = child;
  this._buttons[i] = div;
 
  var childchild = div.firstChild;
  
  while (childchild && __getTagName (childchild) != 'object' && 
        __getTagName (childchild) != 'OBJECT')
  { childchild = childchild.nextSibling; }
  
  if (!childchild)
  {
    printlnConsole ("ERROR ABCheckButton.initStateView 1");
    return;
  }
  this._images [i] = childchild;

  childchild = childchild.nextSibling;
  while (childchild && __getTagName (childchild) != 'p' && 
        __getTagName (childchild) != 'P')
  { childchild = childchild.nextSibling; }
  if (!childchild)
  {
    printlnConsole ("ERROR ABCheckButton.initStateView 2");
    return;
  }
  this._texts [i] = childchild;
 
  childchild = childchild.nextSibling;
  while (childchild && __getTagName (childchild) != 'div' && 
        __getTagName (childchild) != 'DIV')
  { childchild = childchild.nextSibling; }
  if (!childchild)
  {
    printlnConsole ("ERROR ABCheckButton.initStateView 3");
    return;
  }
  this._checks [i] = childchild;;
  
  child = child.nextSibling;
  return child;
}
abcheckbutton_proto._initButton = abcheckbutton_init_button;

/**
 *
 *  @name initSkin
 *  @function
 *  @memberOf ABCheckButton.prototype
 *
 *  @protected
 */
function abcheckbutton_initSkin ()
{
  this.apply ('ABView', 'initSkin');
  
  if (this.view)
  {
    var child = this.view.firstChild;
    var index = 0;
    while (child)
    {
      child = this._initButton (child, index);
      index++;
    }
    
    this.setSize (__getSize (this.view));
  }
}
abcheckbutton_proto.initSkin = abcheckbutton_initSkin;

var ABCheckButton = Class.create ('ABCheckButton', abcheckbutton_proto);
Class.extend ('ABCheckButton', 'ABView');

/*
*                    COPYRIGHT NOTICE
*
* Copyright (C) 2009-2011. ViniSketch SARL (c) All rights reserved
*
* THIS SOURCE CODE, ALL THE INTELLECTUAL PROPERTY RIGHTS THAT IT
* CONTAINS, AND ALL COPYRIGHTS PERTAINING THERETO ARE THE EXCLUSIVE
* PROPERTY OF VINISKETCH.
*
* THIS SOURCE CODE SHALL NOT BE DISTRIBUTED, COPIED OR REPRODUCED IN
* FULL OR IN PART, NOR SHALL DERIVATIVE WORKS BE CREATED BASED ON THIS
* SOURCE CODE OR THE RELATED SPECIFICATION.
*
* THIS SOURCE CODE MAY BE USED OR COMPILED SOLELY FOR THE PURPOSE OF
* PORTING THE PRODUCT ONTO VENDOR'S SOLUTION. THIS SOURCE
* CODE MAY NOT BE MODIFIED, EVEN PARTIALLY.
*
* THE PRESENT COPYRIGHT NOTICE MAY NOT BE CHANGED NOR REMOVED FROM THE
* PRESENT FILE.
*/

var page_proto = new Object ();

/**
 * @protected
 */
page_proto.__nagivation_graph = null;

/**
 *  A Page Class is the main View of a application. It refers to a xxx.bml 
 *  document.
 *
 *  @extends ABView
 *  @class
 *  An application is composed of a main page (index.bml) and can references
 *  a set of other pages ([name].bml).
 *  <p>
 *  The developer has the choice to create a one page application or a multiple 
 *  pages Application. <br/> If his application use lot of panels it can be more 
 *  suitable to create a multiple pages application to reduce the loading time, 
 *  and the memory use.
 *
 *  @author David Thevenin
 *
 *  @constructor
 *  Main constructor
 *  @name Page
 *
 *	@param {string} config the configuration stucture [mandatory]
*/
function page_constructor (config)
{
  this.apply ('ABView', '_constructor', config);
  __init_keyboard_handler ();
  
  Page_pages [this.id] = this;
};
page_proto._constructor = page_constructor;

/**
 * @private
 */
var Page_pages = new Object ();


/**
* @protected
*/
function page_initSkin ()
{
  this.apply ('ABView', 'initSkin');

  this.body = this.view;
      
  KEYBOARD.bind (KEYBOARD.UP_ARROW, this, 'keyboardListener');
  KEYBOARD.bind (KEYBOARD.DOWN_ARROW, this, 'keyboardListener');
  KEYBOARD.bind (KEYBOARD.LEFT_ARROW, this, 'keyboardListener');
  KEYBOARD.bind (KEYBOARD.RIGHT_ARROW, this, 'keyboardListener');
  KEYBOARD.bind (KEYBOARD.KEY_UP + KEYBOARD.ENTER, this,
    'keyboardListener');
  KEYBOARD.bind (KEYBOARD.ENTER, this, 'keyboardListener');
}
page_proto.initSkin = page_initSkin;


/*****************************************************************
 *              Inter page navigation
 ****************************************************************/

/**
 *  Navigation to an other application's page.
 *
 *  @name goToPage
 *  @function
 *  @memberOf Page.prototype
 *
 *	@param {String} name The page name
 *	@param {String} params a string parameter. this parameter will shared with
 *      the target page.(does not work for now)
 */
function page_goToPage (name, params)
{
  if (!name) { return; }
  browser.lockScreen ();
  if (params)
  {
    browser.launchDocument (name + ".bml?" + params);
  }
  else
  {
    browser.launchDocument (name + ".bml");
  }
  browser.unlockScreen ();
}
page_proto.goToPage = page_goToPage;

/** 
 * Return to the main Application's page.
 *
 * @name goToIndexPage
 * @function
 * @memberOf Page.prototype
 *
 *	@param {String} params a string parameter. this parameter will shared with
 *      the index page.(does not work for now)
 */ 
function page_goToIndexPage (params)
{
  browser.lockScreen ();
  if (params)
  {
    browser.launchDocument ("index.bml?" + params);
  }
  else
  {
    browser.launchDocument ("index.bml");
  }
  browser.unlockScreen ();
}
page_proto.goToIndexPage = page_goToIndexPage;


/*****************************************************************
 *              Inner page navigation
 ****************************************************************/

/**
 * @protected
 */
function page_setNavigationGraph (graph)
{
  if (!graph) { return; }
  
  this.__nagivation_graph = graph;
}
page_proto.setNavigationGraph = page_setNavigationGraph;

/**
 * @private
 */
function page_has_navigation (event)
{
  if (!Page._current_focus_comp)
  { return false; }

  if (!this.__nagivation_graph) { return false; }

  var comp = Page._current_focus_comp;  
  var navData = this.__nagivation_graph [comp.id];
  if (navData)
  {
    var id = navData [event.type];
    if (ABObject._obs [id])
    {
      return true;
    }
  }
  return false;
}
page_proto._hasNavigation = page_has_navigation;
 
/*****************************************************************
 *
 ****************************************************************/
 
 /**
 * @private
 */
function page_keyboardListener (event)
{
  if (!Page._current_focus_comp)
  { return false; }

  var comp = Page._current_focus_comp;
    
  if (!comp)
  { return false; }
  
  if (!this.__nagivation_graph) { return false; }
  
  browser.lockScreen ();

  var navData = this.__nagivation_graph [comp.id];
  var lost_focus = false;
  if (navData)
  {
    var id = navData [event.type];
    if (ABObject._obs [id])
    {
      ABObject._obs [id]._onFocus ();
      comp._onBlur ();
      lost_focus = true;
    }
  }
 
  if (event.type == KEYBOARD.UP_ARROW) {
    comp._onUp ();
  }

  else if (event.type == KEYBOARD.DOWN_ARROW) {
    comp._onDown ();
  }

  else if (event.type == KEYBOARD.LEFT_ARROW) {
    comp._onLeft ();
  }

  else if (event.type == KEYBOARD.RIGHT_ARROW) {
    comp._onRight ();
  }
 
  else if (event.type == KEYBOARD.ENTER) {
    comp._onBeforeActive ();
  }
 
  else if (event.type == KEYBOARD.ENTER + KEYBOARD.KEY_UP) {
    comp._onActive ();
  }

  browser.unlockScreen ();
  return lost_focus;
}
page_proto.keyboardListener = page_keyboardListener;

/** 
 * Set the description of playback control procedure for your LIME
 * Application. <br/>
 * Please refer to the ARIB documentation for all key list. You 
 * can for instance specify :
 * <ul>
 * <li/> basic: Up, down, right and left arrow keys, enter key and back 
 *       key
 * <li/>data-button: Keys for data broadcasting operations (e.g., red, green, *
 *      blue and yellow colour keys)
 * <li/> numeric-tuning: Channel keypad (0 to 9, or 0 to 12)
 * <li/> etc.
 * </ul>
 *
 *  @example
 *  this.setUsedKeyList ("basic data-button");
 *
 * @name setUsedKeyList
 * @function
 * @memberOf Page.prototype
 *
 * @param {String} code the key code
 */ 
function page_usedKeyList (code)
{
  if (!this.body) { return; }
  
  this.body.normalStyle.usedKeyList = code;
};
page_proto.setUsedKeyList = page_usedKeyList;

/*****************************************************************
 *
 ****************************************************************/

/**
 *  Set the focus to your application.
 *  <br/>
 *  If you change manually the focus you have to give the focus to
 *  the application if you want it react to TV control events.
 *
 *  @name setFocus
 *  @function
 *  @memberOf Page.prototype
 *
 * @public
 */
function page_setFocus ()
{
  __init_keyboard_handler ();
}
page_proto.setFocus = page_setFocus;

/*****************************************************************
 *
 ****************************************************************/
 
var Page = Class.create ('Page', page_proto);
Class.extend ('Page', 'ABView');


// because focus is call before the keyboard event,
// we manage a double focus comp system : the current and the new
// If a new is set it means focus just change and we have to send
// keyboard event to the previous one (current) and change the current
// comp with the new one
// If new is null is means we receive a keyboard event without focus change
// then we just have to sen event to current comp.
Page._current_focus_comp = null;

/**
 * @private
 */
function page_sendStart ()
{
  var key, obj;
  for (key in Page_pages)
  {
    obj = Page_pages [key];
    obj.propagate ('start');
//    if (obj.propagate) { obj.propagate ('start'); }
  }
}
Page.sendStart = page_sendStart;
/**
 Copyright (C) 2009-2011. ViniSketch SARL - David Thevenin

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

var application_proto = new Object ();

application_proto.__nagivation_graph = null;

/**
 *  All application inherit from Application class.<br/>
 *  This is the root component from which all other components (widgets, ...)
 *  are dependent on.
 *
 *  @extends Page
 *  @class
 *  All application inherit from Application class. <br/>
 *  This is the root component from which all other components (widgets, ...)
 *  are dependent on.
 *  <p>
 *  The class offers you a set of usefull method for laoding
 *  Javascript or CSS, know the current GUI orientation...
 *  <p>
 *  You should not create your own Application instante, because it is
 *  automatically generated by ViniSketch Designer.
 *
 *  @author David Thevenin
 *
 *  @constructor
 *  Main constructor
 *  @name Application
 *
 *	@param {string} config the configuration stucture [mandatory]
*/
function application_constructor (config)
{
  this.apply ('Page', '_constructor', config);
  
  Application_applications [this.id] = this;
};
application_proto._constructor = application_constructor;

/**
 * @private
 */
var Application_applications = new Object ();

/**
 *  Exit form the application
 *  <br/>
 *
 *  @name exit
 *  @function
 *  @memberOf Application.prototype
 */
function application_exit ()
{
  if (close)
  {
    close ();
  }
}
application_proto.exit = application_exit;

/*****************************************************************
 *             Class declaration
 ****************************************************************/

var Application = Class.create ('Application', application_proto);
Class.extend ('Application', 'Page');